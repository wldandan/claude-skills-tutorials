# 特性 03: 磁盘 IO 异常检测与分析

## 功能概述

提供磁盘 IO 性能异常检测和分析能力，涵盖磁盘吞吐量瓶颈、IO 延迟突增、磁盘空间不足、IO 等待过高等问题。通过分析 IO 请求队列、读写延迟、吞吐量、iops 等指标，快速定位磁盘性能问题的根本原因（单个进程、存储设备、文件系统等）。

## 用户场景

**场景 1: IO 等待过高导致系统负载高**
- 系统负载很高但 CPU 使用率低，iowait > 50%
- 需要定位是哪个磁盘或进程导致 IO 瓶颈
- 使用 `aiops analyze iowait` 快速识别 IO 瓶颈

**场景 2: 磁盘性能突降**
- 应用读写延迟突然从 10ms 升至 500ms
- 需要分析是硬件问题还是进程异常
- 使用 `aiops detect io-anomaly --device sda` 检测异常

**场景 3: 磁盘空间即将耗尽**
- 磁盘使用率 > 90%，需要快速清理
- 需要找出占用空间最大的目录和文件
- 使用 `aiops analyze disk-usage --top-dirs` 定位大文件

## 技术方案概要

### 数据采集层
- 读取 `/proc/diskstats` 获取磁盘 IO 统计（读写字节数、IO 次数、IO 时间）
- 读取 `/proc/<pid>/io` 获取进程级 IO 统计（读写字节数、读写调用次数）
- 读取 `/sys/block/<dev>/queue/*` 获取设备队列参数
- 使用 `iostat -x` 采集详细 IO 指标（%iowait、await、svctm 等）
- 使用 `iotop` 识别高 IO 进程
- 使用 `du`、`ncdu` 分析磁盘使用

### 异常检测算法
- **IO 延迟异常**: 检测 await（平均等待时间）突增
- **吞吐量异常**: 检测读写速率突降或突增（如异常的批量写）
- **队列深度异常**: 检测 avgqu-sz（平均队列长度）异常
- **IO 等待异常**: 检测 %iowait 持续过高

### 根因分析
- **进程级 IO 排名**: 列出 IO 读写字节数、IO 次数最多的进程
- **设备级分析**: 识别瓶颈设备（HDD/SSD/NVMe/网络存储）
- **文件级分析**: 识别热点文件（使用 eBPF 或 inotify）
- **IO 模式分析**: 识别顺序读写 vs 随机读写模式
- **关联分析**: 关联同时间段的 CPU、内存、网络指标

## 核心功能点

### 1. IO 性能实时监控
```bash
# 实时监控磁盘 IO 性能
aiops monitor io --interval 1 --devices all
```
- 显示每个磁盘的吞吐量（read/s、write/s）
- 显示 IOPS、平均队列深度、平均等待时间
- 异常指标高亮（延迟 > 阈值、队列深度 > 阈值）
- Top 高 IO 进程列表

### 2. IO 异常检测
```bash
# 检测过去 1 小时的 IO 异常
aiops detect io-anomaly --time-range 1h --device sda
```
- 检测 IO 延迟突增（await > 阈值）
- 检测吞吐量突降（性能衰减）
- 检测队列深度异常（IO 拥塞）
- 关联时间段的高 IO 进程

### 3. 进程 IO 分析
```bash
# 分析指定进程的 IO 情况
aiops analyze io --pid <pid> --detail
```
- 进程的读写字节数、IO 次数
- IO 读写速率趋势
- IO 等待时间占比
- 热点文件列表（如果有 eBPF 支持）

### 4. 磁盘使用分析
```bash
# 分析磁盘使用情况
aiops analyze disk-usage --mountpoint / --top-dirs 20
```
- 显示磁盘使用率和剩余空间
- 列出占用空间最大的 Top N 目录
- 识别大文件（>100MB）
- 预测磁盘空间耗尽时间（基于历史增长率）

### 5. IO 等待分析
```bash
# 分析系统 IO 等待过高问题
aiops analyze iowait --threshold 20%
```
- 识别 iowait 过高的时间段
- 识别导致 iowait 的磁盘和进程
- 分析 IO 请求模式（顺序/随机）
- 提供优化建议（调整 IO 调度器、使用 SSD、优化应用）

### 6. 磁盘性能基准测试
```bash
# 测试磁盘性能基线
aiops benchmark disk --device sda --size 1G
```
- 使用 fio 测试顺序/随机读写性能
- 测试不同队列深度和块大小的性能
- 生成性能报告和基线数据
- 与历史基线对比

### 7. 文件系统分析
```bash
# 分析文件系统性能和健康度
aiops analyze fs --mountpoint /
```
- 文件系统类型（ext4/xfs/nfs）
- inode 使用情况
- 文件系统挂载选项
- 碎片化程度（xfs_fsr、e4defrag）

## 验收标准 (Acceptance Criteria)

### AC 1: IO 数据采集准确性
- **Given**: Linux 系统运行正常
- **When**: 执行 `aiops collect io --duration 60s`
- **Then**:
  - 采集的吞吐量与 `iostat -x` 结果一致（误差 < 5%）
  - 采集的 IOPS 准确无误（误差 < 2%）
  - avgqu-sz、await、svctm 等指标与 iostat 一致（误差 < 5%）

### AC 2: IO 异常检测准确性
- **Given**: 系统存在 IO 异常（延迟 > 100ms 持续 5 分钟）
- **When**: 执行 `aiops detect io-anomaly --time-range 1h`
- **Then**:
  - 检测到异常事件，准确率 >= 90%（基于标注测试集）
  - 误报率 <= 10%（正常时段误报）
  - 检测延迟 <= 60 秒

### AC 3: 进程 IO 统计准确性
- **Given**: 指定进程正在进行 IO 操作
- **When**: 执行 `aiops analyze io --pid <pid>`
- **Then**:
  - 读写字节数与 `/proc/<pid>/io` 一致（误差 < 2%）
  - IO 次数准确无误
  - 能正确识别进程的 IO 速率

### AC 4: 磁盘使用分析准确性
- **Given**: 磁盘有大量文件和目录
- **When**: 执行 `aiops analyze disk-usage --mountpoint / --top-dirs 10`
- **Then**:
  - 磁盘使用率与 `df -h` 一致（误差 < 1%）
  - Top 目录占用大小与 `du -sh` 一致（误差 < 5%）
  - 分析完成时间 < 30 秒（100 万文件以内）

### AC 5: 性能与资源占用
- **Given**: 系统正常运行
- **When**: 启动 `aiops monitor io --daemon` 后台运行
- **Then**:
  - 工具自身 CPU 占用 < 3%（单核）
  - 内存占用 < 120MB
  - 磁盘写入 < 10MB/hour
  - 不对系统 IO 造成明显影响（< 1% 吞吐量）

### AC 6: 历史数据查询
- **Given**: 已采集 30 天的 IO 数据
- **When**: 执行 `aiops query io --start "2024-01-01" --end "2024-01-07"`
- **Then**:
  - 返回指定时间段的所有数据点
  - 查询响应时间 < 3 秒（7 天数据）
  - 支持按设备、进程聚合

### AC 7: eBPF 热点文件分析
- **Given**: 系统支持 eBPF（内核 >= 4.1）
- **When**: 执行 `aiops analyze io --pid <pid> --hot-files --duration 60s`
- **Then**:
  - 使用 eBPF 追踪文件读写
  - 列出读写最频繁的 Top 20 文件
  - 采集开销 < 5% CPU 和 IO

### AC 8: 磁盘空间预测
- **Given**: 磁盘使用率 > 80%，有历史增长趋势
- **When**: 执行 `aiops predict disk-full --mountpoint /`
- **Then**:
  - 基于历史增长率预测耗尽时间
  - 预测误差 < 30%（与实际对比）
  - 提供清理建议（可清理的文件）

## 依赖项

### 系统依赖
- **操作系统**: Linux (内核 >= 3.10)
- **Python**: Python 3.8+
- **工具**: iostat、iotop、du（系统自带或需要安装 sysstat 包）
- **权限**: 普通用户权限，eBPF 功能需要 root

### Python 库依赖
```
psutil>=5.9.0          # 磁盘 IO 采集
pandas>=2.0.0          # 数据处理
numpy>=1.24.0          # 数值计算
scikit-learn>=1.3.0    # 异常检测
click>=8.1.0           # CLI 框架
rich>=13.0.0           # 终端美化
```

### 可选依赖
```
bpfcc>=0.20.0          # eBPF 工具（热点文件分析）
```

## 优先级

**P0 (必须实现)**
- AC 1: IO 数据采集准确性
- AC 4: 磁盘使用分析准确性
- AC 5: 性能与资源占用
- 核心功能点 1, 4

**P1 (首版本必备)**
- AC 2: IO 异常检测
- AC 3: 进程 IO 统计
- AC 6: 历史数据查询
- 核心功能点 2, 3, 5

**P2 (后续版本优化)**
- AC 7: eBPF 热点文件分析
- AC 8: 磁盘空间预测
- 核心功能点 6, 7

## 输出示例

### IO 异常检测输出
```bash
$ aiops detect io-anomaly --time-range 1h --device sda

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 磁盘 IO 异常检测报告                                  2024-01-15 14:30:25 ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 设备: sda                                                        │
│ 检测时间范围: 2024-01-15 13:30:00 - 14:30:00                     │
│ 检测算法: 阈值检测 + STL 分解                                     │
├──────────────────────────────────────────────────────────────────┤
│ ⚠️  检测到 1 个异常事件                                            │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│ 🚨 事件 #1: High IO Latency (Critical)                            │
│    时间: 2024-01-15 14:10:15 - 14:15:30 (持续 5分15秒)           │
│    指标异常:                                                      │
│      - await: 285.3ms (基线: 12.5ms, ↑ 2182%)                   │
│      - svctm: 198.7ms (基线: 8.2ms, ↑ 2323%)                   │
│      - avgqu-sz: 15.2 (基线: 1.3, ↑ 1070%)                      │
│    吞吐量变化:                                                    │
│      - read/s: 5.2 MB/s (↓ 65%)                                  │
│      - write/s: 1.1 MB/s (↓ 82%)                                 │
│    置信度: 94.7%                                                 │
│                                                                  │
│ 🔍 根因分析:                                                      │
│    Top 高 IO 进程 (事件时段):                                     │
│      1. mysqld (PID 2891) - 85.2% read                          │
│         - 读取速率: 4.8 MB/s                                     │
│         - IO 次数: 1,250 ops/s                                   │
│      2. java (PID 15234) - 8.3% write                           │
│         - 写入速率: 0.5 MB/s                                     │
│    设备信息:                                                      │
│      - 类型: HDD (旋转硬盘)                                       │
│      - 调度器: deadline                                          │
│      - 队列深度: 256                                             │
│    IO 模式: 85% 随机读取（高 IO 等待）                            │
│                                                                  │
│ 💡 建议优化:                                                      │
│    短期:                                                          │
│      1. 调整 MySQL 缓冲池大小（减少磁盘读取）                      │
│      2. 优化慢查询（添加索引）                                    │
│      3. 调整 IO 调度器为 cfq（适合数据库）                         │
│    长期:                                                          │
│      1. 迁移到 SSD/NVMe                                          │
│      2. 使用 RAID 10 提升读写性能                                 │
│      3. 分离热数据到高速存储                                       │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 磁盘使用分析输出
```bash
$ aiops analyze disk-usage --mountpoint / --top-dirs 10

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 磁盘使用分析                                         2024-01-15 14:30:25 ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 挂载点: / (根分区)                                              │
│ 文件系统: ext4                                                   │
│ 磁盘总容量: 500 GB                                               │
├──────────────────────────────────────────────────────────────────┤
│ 📊 空间使用:                                                      │
│   已使用: 425.3 GB (85.1%) ⚠️                                     │
│   可用: 74.7 GB (14.9%)                                          │
│   Inode 已用: 1,245,892 / 32,000,000 (3.9%)                     │
├──────────────────────────────────────────────────────────────────┤
│ ⏱️  空间耗尽预测:                                                  │
│   过去 7 天增长: +12.5 GB (平均 1.8 GB/day)                     │
│   按当前增长速率，预计 41 天后磁盘空间耗尽                         │
│   耗尽时间估算: 2024-02-25                                       │
├──────────────────────────────────────────────────────────────────┤
│ 📁 Top 10 占用空间目录:                                            │
│   1. /var          180.2 GB  (36.0%)  ↑ 2.3 GB/week             │
│      └─ /var/lib    168.5 GB  (33.7%)                            │
│         └─ docker   152.3 GB  (30.5%)  Docker 镜像和容器          │
│   2. /home         95.7 GB   (19.1%)  用户数据                    │
│   3. /usr          68.2 GB   (13.6%)  系统软件                    │
│   4. /opt          42.1 GB   (8.4%)   第三方应用                  │
│   5. /log          28.5 GB   (5.7%)   日志文件  ⚠️ 增长较快        │
│   6. /tmp          8.3 GB    (1.7%)  临时文件                    │
│   7. /root         2.1 GB    (0.4%)  root 用户                   │
│   8. /etc          1.2 GB    (0.2%)  配置文件                    │
│   9. /boot         0.8 GB    (0.2%)  内核和启动文件               │
│  10. /var/log      156.3 MB  (0.0%)  系统日志                    │
├──────────────────────────────────────────────────────────────────┤
│ 🗑️  建议清理项:                                                    │
│   - Docker 旧镜像: docker system prune -a                        │
│   - 系统日志: journalctl --vacuum-time=7d                       │
│   - 临时文件: rm -rf /tmp/* (慎重)                               │
│   - 日志归档: tar -czf /backup/logs.tar.gz /log/*.log            │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

## 后续演进方向

1. **RAID 分析**: 支持 RAID 设备性能分析和故障预测
2. **网络存储分析**: 支持 NFS、iSCSI、Ceph 等网络存储分析
3. **IO 调优建议**: 自动生成 IO 调度器、挂载选项优化建议
4. **实时 IO 追踪**: 使用 eBPF 追踪每个 IO 请求的完整路径
