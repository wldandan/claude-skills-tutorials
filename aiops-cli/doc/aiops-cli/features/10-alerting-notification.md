# 特性 10: 智能告警与通知系统

## 功能概述

提供智能化的告警与通知系统，支持基于规则和机器学习的异常检测告警，多通道通知（邮件、短信、Webhook、Slack、钉钉、企业微信），告警聚合、抑制、升级策略，帮助运维人员及时发现和响应问题，减少告警疲劳。

## 用户场景

**场景 1: 配置 CPU 使用率告警**
- 需要在 CPU 使用率超过 90% 时收到告警
- 配置告警规则和通知渠道
- 使用 `aiops alert create --condition cpu>90` 创建告警

**场景 2: 配置智能告警（基于 ML）**
- 需要检测 CPU 异常（基于历史基线）
- 使用机器学习检测异常，而非固定阈值
- 使用 `aiops alert create --anomaly cpu --algorithm isolation_forest` 创建智能告警

**场景 3: 配置告警聚合和抑制**
- 多个相似告警需要聚合为一个
- 避免告警风暴
- 使用 `aiops alert policy --group-by similar` 配置聚合策略

## 技术方案概要

### 告警规则引擎
- **规则语法**: 支持 PromQL 类似的查询语言
- **规则类型**: 阈值告警、趋势告警、缺失数据告警、异常检测告警
- **规则评估**: 周期性评估规则（如每 30 秒）
- **规则优先级**: P0/P1/P2/P3

### 告警检测算法
- **静态阈值**: 固定阈值（如 CPU > 90%）
- **动态阈值**: 基于历史基线（如 CPU > 基线 + 3σ）
- **ML 异常检测**: Isolation Forest、One-Class SVM、LSTM
- **智能告警**: 结合多指标判断（如 CPU 高 且 内存高）

### 告警聚合与抑制
- **时间聚合**: 时间窗口内的相似告警聚合
- **空间聚合**: 多个主机的相似告警聚合
- **依赖抑制**: 根因告警抑制症状告警（如网络故障抑制服务不可用）
- **重复抑制**: 相同告警在冷却期内不重复发送

### 告警路由与升级
- **基于标签路由**: 根据告警标签路由到不同团队
- **基于严重程度路由**: P0 告警电话通知，P1 邮件通知
- **告警升级**: 未确认告警自动升级（如 30 分钟未处理升级到主管）
- **On-call 轮换**: 支持 On-call 排班和自动轮换

### 通知通道
- **邮件**: SMTP 邮件通知
- **短信**: 支持阿里云、腾讯云短信服务
- **Webhook**: 通用 Webhook（集成企业系统）
- **IM**: Slack、钉钉、企业微信、飞书
- **自定义**: 支持自定义通知脚本

## 核心功能点

### 1. 告警规则管理
```bash
# 创建告警规则
aiops alert create --name "high_cpu" --condition "cpu.percent > 90" --severity critical

# 列出告警规则
aiops alert list

# 查看告警规则详情
aiops alert show --name high_cpu

# 删除告警规则
aiops alert delete --name high_cpu

# 启用/禁用告警规则
aiops alert enable --name high_cpu
aiops alert disable --name high_cpu
```

### 2. 智能告警配置
```bash
# 创建异常检测告警
aiops alert create --name "cpu_anomaly" --type anomaly --metric cpu.percent --algorithm isolation_forest

# 创建趋势告警
aiops alert create --name "disk_full_soon" --type trend --metric disk.usage --predict 24h

# 创建复合条件告警
aiops alert create --name "high_load" --condition "cpu.percent > 80 and mem.percent > 80"
```

### 3. 通知通道配置
```bash
# 配置邮件通知
aiops notification add --type email --smtp smtp.example.com --to ops@example.com

# 配置钉钉通知
aiops notification add --type dingtalk --webhook https://oapi.dingtalk.com/robot/send

# 配置 Slack 通知
aiops notification add --type slack --webhook https://hooks.slack.com/services/...

# 配置短信通知
aiops notification add --type sms --provider aliyun --phone 13800138000
```

### 4. 告警策略配置
```bash
# 配置告警聚合策略
aiops alert policy --group-by similar --window 10m --threshold 5

# 配置告警抑制策略
aiops alert policy --suppress-if network.down --suppress service.unavailable

# 配置告警升级策略
aiops alert policy --escalate-after 30m --escalate-to manager
```

### 5. 告警历史查询
```bash
# 查询告警历史
aiops alert history --time-range 24h

# 查看告警详情
aiops alert show --id <alert_id>

# 统计告警
aiops alert stats --period 7d
```

### 6. 告警确认与关闭
```bash
# 确认告警
aiops alert acknowledge --id <alert_id> --message "正在处理"

# 关闭告警
aiops alert close --id <alert_id> --resolution "已修复"

# 添加告警备注
aiops alert comment --id <alert_id> --comment "正在排查"
```

### 7. 静默与维护模式
```bash
# 静默告警（临时禁用）
aiops alert silence --name high_cpu --duration 1h

# 设置维护模式
aiops maintenance start --duration 2h --reason "系统升级"

# 结束维护模式
aiops maintenance stop
```

### 8. 告警测试
```bash
# 测试告警规则
aiops alert test --name high_cpu

# 测试通知通道
aiops notification test --type email
```

## 验收标准 (Acceptance Criteria)

### AC 1: 告警规则触发准确性
- **Given**: 配置告警规则 `cpu.percent > 90`
- **When**: CPU 使用率达到 95%
- **Then**:
  - 在 30 秒内触发告警
  - 告警信息包含准确的指标值和时间戳
  - 误报率 < 1%（正常时段不触发）

### AC 2: 通知送达及时性
- **Given**: 配置邮件和钉钉通知
- **When**: 告警触发
- **Then**:
  - 邮件在 1 分钟内送达
  - 钉钉消息在 30 秒内送达
  - 通知内容完整（包含告警详情、时间、建议操作）

### AC 3: 告警聚合有效性
- **Given**: 配置告警聚合策略（时间窗口 10 分钟，阈值 5）
- **When**: 在 10 分钟内触发 10 个相似告警
- **Then**:
  - 聚合为 1 个告警通知
  - 通知中包含聚合信息（触发了 10 次）
  - 减少告警噪音 >= 80%

### AC 4: 智能告警准确性
- **Given**: 配置异常检测告警（Isolation Forest）
- **When**: CPU 出现异常（偏离历史基线）
- **Then**:
  - 检测到异常，准确率 >= 85%（基于标注测试集）
  - 误报率 <= 15%
  - 检测延迟 <= 60 秒

### AC 5: 告警抑制正确性
- **Given**: 配置依赖抑制（网络故障抑制服务不可用）
- **When**: 网络故障导致服务不可用
- **Then**:
  - 只触发网络故障告警
  - 服务不可用告警被抑制
  - 告警依赖关系中显示抑制原因

### AC 6: 告警升级及时性
- **Given**: 配置告警升级策略（30 分钟未处理升级到主管）
- **When**: P1 告警触发后 30 分钟未确认
- **Then**:
  - 自动发送升级通知给主管
  - 通知中包含原始告警信息和升级原因
  - 升级时间准确（误差 < 2 分钟）

### AC 7: 维护模式正确性
- **Given**: 进入维护模式（2 小时）
- **When**: 维护期间触发告警条件
- **Then**:
  - 不发送告警通知
  - 记录告警事件（标记为维护期间）
  - 维护结束后恢复正常告警

### AC 8: 告警性能
- **Given**: 配置 100 个告警规则
- **When**: 运行告警评估
- **Then**:
  - 评估周期 < 30 秒（所有规则）
  - CPU 占用 < 10%
  - 内存占用 < 200MB
  - 不影响数据采集和存储

## 依赖项

### 系统依赖
- **操作系统**: Linux (内核 >= 3.10)
- **Python**: Python 3.8+
- **网络**: 访问外部服务（邮件服务器、Webhook）

### Python 库依赖
```
pandas>=2.0.0          # 数据处理
numpy>=1.24.0          # 数值计算
scikit-learn>=1.3.0    # ML 异常检测
click>=8.1.0           # CLI 框架
pyyaml>=6.0            # 配置文件解析
requests>=2.31.0       # HTTP 请求
```

### 可选依赖
```
jinja2>=3.1.0          # 告警消息模板
```

## 优先级

**P0 (必须实现)**
- AC 1: 告警规则触发
- AC 2: 通知送达
- AC 8: 告警性能
- 核心功能点 1, 3

**P1 (首版本必备)**
- AC 3: 告警聚合
- AC 7: 维护模式
- 核心功能点 2, 4, 5, 7

**P2 (后续版本优化)**
- AC 4: 智能告警
- AC 5: 告警抑制
- AC 6: 告警升级
- 核心功能点 6, 8

## 输出示例

### 告警规则列表输出
```bash
$ aiops alert list

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 告警规则列表                                         2024-01-15 14:30:25 ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 总规则数: 15                                                     │
│ 启用: 12 | 禁用: 3                                              │
├──────────────────────────────────────────────────────────────────┤
│ ┌───────┬─────────────────┬──────────────────────┬────────┬──────┐ │
│ │ 名称  │ 条件/类型        │ 描述                 │ 严重性 │ 状态 │ │
│ ├───────┼─────────────────┼──────────────────────┼────────┼──────┤ │
│ │ high_cpu │ cpu.percent > 90 │ CPU 使用率过高     │ Critical│ 启用 │ │
│ │ high_mem │ mem.percent > 85 │ 内存使用率过高     │ Warning │ 启用 │ │
│ │ disk_full │ disk.usage > 90  │ 磁盘空间不足       │ Critical│ 启用 │ │
│ │ cpu_anomaly │ anomaly(cpu)   │ CPU 异常检测       │ Warning │ 启用 │ │
│ │ oom_detect │ event(oom)      │ OOM 事件检测       │ Critical│ 启用 │ │
│ │ service_down │ service == down │ 服务不可用        │ Critical│ 启用 │ │
│ │ ...    │ ...             │ ...                 │ ...    │ ...  │ │
│ └───────┴─────────────────┴──────────────────────┴────────┴──────┘ │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 告警历史输出
```bash
$ aiops alert history --time-range 24h

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 告警历史                                             2024-01-15 14:30:25 ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 时间范围: 2024-01-14 14:30:25 - 2024-01-15 14:30:25               │
├──────────────────────────────────────────────────────────────────┤
│ 📊 统计摘要:                                                      │
│   总告警数: 45                                                   │
│   已确认: 38 (84.4%)                                            │
│   已关闭: 35 (77.8%)                                            │
│   待处理: 10 (22.2%)                                            │
│   误报: 2 (4.4%)                                               │
│                                                                  │
│   严重性分布:                                                    │
│     • Critical: 8 (17.8%)                                       │
│     • Warning: 25 (55.6%)                                       │
│     • Info: 12 (26.6%)                                         │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 🔔 最近告警 (Top 10):                                             │
│                                                                  │
│ 1. ⚠️  [CRITICAL] high_cpu                                       │
│    告警 ID: alert_20240115_141523                               │
│    触发时间: 2024-01-15 14:15:23                                │
│    指标: cpu.percent = 94.2%                                     │
│    持续时间: 5 分 22 秒                                          │
│    状态: 🔄 已确认 (处理中)                                      │
│    处理人: admin (2024-01-15 14:16:00)                          │
│    备注: 正在排查 Java 进程高 CPU                                │
│                                                                  │
│ 2. ⚠️  [WARNING] high_mem                                        │
│    告警 ID: alert_20240115_141845                               │
│    触发时间: 2024-01-15 14:18:45                                │
│    指标: mem.percent = 85.6%                                     │
│    持续时间: 11 分 40 秒 (持续中)                                │
│    状态: ⏳ 待处理                                              │
│    通知通道: 邮件 (已发送), 钉钉 (已发送)                        │
│                                                                  │
│ 3. ✅ [CRITICAL] disk_full                                      │
│    告警 ID: alert_20240115_101230                               │
│    触发时间: 2024-01-15 10:12:30                                │
│    指标: disk.usage (/var) = 92.3%                              │
│    状态: ✅ 已关闭                                              │
│    处理人: admin                                                │
│    解决方案: 清理了 Docker 镜像和日志文件                        │
│    关闭时间: 2024-01-15 10:45:00 (耗时 32 分 30 秒)             │
│                                                                  │
│ 4. ✅ [WARNING] cpu_anomaly                                     │
│    告警 ID: alert_20240115_082345                               │
│    触发时间: 2024-01-15 08:23:45                                │
│    状态: ✅ 已关闭 (误报)                                        │
│    备注: 实际是正常业务高峰，已调整基线                          │
│                                                                  │
│ ... (省略 6 个告警)                                              │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 📈 趋势分析 (过去 24 小时):                                        │
│   告警频率: 平均 1.9 次/小时                                      │
│   峰值时段: 14:00-15:00 (12 次告警)                             │
│   最常见告警: high_cpu (8 次), high_mem (7 次)                  │
│   平均响应时间: 8 分 23 秒                                        │
│   平均解决时间: 25 分 12 秒                                       │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 告警详情输出
```bash
$ aiops alert show --id alert_20240115_141523

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 告警详情                                             2024-01-15 14:30:25 ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 告警 ID: alert_20240115_141523                                  │
│ 规则名称: high_cpu                                              │
│ 规则描述: CPU 使用率过高                                         │
│ 严重性: Critical                                                │
├──────────────────────────────────────────────────────────────────┤
│ 📅 时间信息:                                                     │
│   触发时间: 2024-01-15 14:15:23                                 │
│   持续时间: 15 分 02 秒 (持续中)                                 │
│   最后更新: 2024-01-15 14:30:20                                │
│   检测延迟: 3 秒                                                │
├──────────────────────────────────────────────────────────────────┤
│ 📊 指标信息:                                                     │
│   指标名称: cpu.percent                                          │
│   当前值: 94.2%                                                 │
│   阈值: 90%                                                     │
│   偏差: +4.2%                                                   │
│   基线: 45.3%                                                  │
│   峰值: 98.7% (14:17:45)                                       │
│   趋势: ↗️ 上升                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 🎯 影响分析:                                                     │
│   影响范围: 系统 CPU 资源紧张，应用响应慢                        │
│   相关指标:                                                      │
│     • loadavg.1 = 15.2 (基线 2.5) ⬆️ 508%                      │
│     • process.cpu(java) = 67.8%                                │
│     • iowait = 12.3% (基线 2.1%) ⬆️ 486%                        │
│   相关进程:                                                      │
│     • java (PID 15234): 67.8% CPU                              │
│     • mysqld (PID 2891): 12.3% CPU                             │
├──────────────────────────────────────────────────────────────────┤
│ 📍 状态信息:                                                     │
│   当前状态: 🔄 已确认 (处理中)                                  │
│   确认人: admin                                                 │
│   确认时间: 2024-01-15 14:16:00                                │
│   处理状态: 排查中                                              │
├──────────────────────────────────────────────────────────────────┤
│ 💬 备注:                                                         │
│   • 2024-01-15 14:16:00 [admin]: 正在排查 Java 进程高 CPU        │
│   • 2024-01-15 14:20:15 [admin]: 发现是内存泄漏导致频繁 GC       │
│   • 2024-01-15 14:25:30 [system]: 自动检测到 OOM 事件           │
├──────────────────────────────────────────────────────────────────┤
│ 🔔 通知记录:                                                     │
│   • 2024-01-15 14:15:25 [邮件] 发送给 ops@example.com (已送达)   │
│   • 2024-01-15 14:15:27 [钉钉] 发送给运维群 (已送达)             │
│   • 2024-01-15 14:16:00 [短信] 发送给 13800138000 (已送达)       │
├──────────────────────────────────────────────────────────────────┤
│ 💡 推荐操作:                                                     │
│   立即:                                                          │
│     1. 查看进程详情: aiops analyze process --pid 15234          │
│     2. 分析内存趋势: aiops analyze memory --pid 15234 --trend    │
│     3. 查看相关日志: aiops logs --correlate --time 14:15        │
│                                                                  │
│   短期:                                                          │
│     1. 重启 Java 服务 (临时缓解)                                 │
│     2. 增加堆内存配置                                            │
│                                                                  │
│   长期:                                                          │
│     1. 修复内存泄漏代码                                          │
│     2. 配置 CPU 限制和告警                                       │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

## 通知消息模板示例

### 邮件通知模板
```html
<!DOCTYPE html>
<html>
<head>
    <style>
        .critical { color: #d32f2f; }
        .warning { color: #f57c00; }
        .info { color: #1976d2; }
    </style>
</head>
<body>
    <h2 class="critical">[CRITICAL] CPU 使用率过高告警</h2>
    <p><strong>主机:</strong> server01.example.com</p>
    <p><strong>时间:</strong> 2024-01-15 14:15:23</p>
    <p><strong>指标:</strong> cpu.percent = 94.2% (阈值: 90%)</p>
    <p><strong>持续时间:</strong> 5 分 22 秒</p>
    <hr>
    <h3>影响分析:</h3>
    <ul>
        <li>系统负载: 15.2 (基线 2.5)</li>
        <li>Top 进程: java (PID 15234) - 67.8% CPU</li>
    </ul>
    <hr>
    <p><strong>推荐操作:</strong></p>
    <ol>
        <li>查看进程详情: aiops analyze process --pid 15234</li>
        <li>分析内存趋势: aiops analyze memory --pid 15234</li>
    </ol>
    <hr>
    <p><small>告警 ID: alert_20240115_141523 | 规则: high_cpu</small></p>
</body>
</html>
```

### 钉钉通知模板
```json
{
    "msgtype": "markdown",
    "markdown": {
        "title": "【CRITICAL】CPU 使用率过高告警",
        "text": "## 【CRITICAL】CPU 使用率过高告警\n\n" +
                "**主机:** server01.example.com\n" +
                "**时间:** 2024-01-15 14:15:23\n" +
                "**指标:** cpu.percent = 94.2% (阈值: 90%)\n" +
                "**持续时间:** 5 分 22 秒\n\n" +
                "> ### 影响分析:\n" +
                "> - 系统负载: 15.2 (基线 2.5)\n" +
                "> - Top 进程: java (PID 15234) - 67.8% CPU\n\n" +
                "### 推荐操作:\n" +
                "1. 查看进程详情: `aiops analyze process --pid 15234`\n" +
                "2. 分析内存趋势: `aiops analyze memory --pid 15234`\n\n" +
                "---\n" +
                "<font color=grey>告警 ID: alert_20240115_141523</font>"
    }
}
```

## 后续演进方向

1. **告警智能化**: 基于历史数据的告警阈值自适应
2. **告警预测**: 预测告警趋势，提前预警
3. **自动化响应**: 告警触发后自动执行修复脚本
4. **告警根因分析**: 自动生成告警的根因分析报告
