# CPU 异常检测功能测试计划

## 文档信息
- **项目**: aiops-cli
- **功能**: Feature 01 - CPU 异常检测与分析
- **版本**: v1.0
- **制定日期**: 2026-01-16
- **测试负责人**: aiops-cli-tester
- **测试周期**: 2026-01-16 至 2026-01-30

---

## 1. 测试范围

### 1.1 功能测试范围
基于规格文档 `/docs/aiops-cli/features/01-cpu-anomaly-detection.md`，本次测试涵盖：

- **数据采集功能**
  - 系统 CPU 数据采集
  - 进程 CPU 数据采集
  - 线程级数据采集
  - 数据准确性验证

- **异常检测功能**
  - 静态阈值检测
  - 动态基线检测
  - 机器学习算法检测
  - 检测准确性验证

- **分析功能**
  - 进程 Top N 识别
  - 线程级别分析
  - CPU 亲和性分析
  - 历史趋势分析

- **命令行接口**
  - 各种命令选项
  - 输出格式（JSON/YAML/Table）
  - 错误处理和提示

### 1.2 非功能测试范围
- **性能测试**
  - 采集速度
  - 检测速度
  - 资源占用（CPU、内存、磁盘）
  - 响应时间

- **边界测试**
  - 极值处理（0%、100% CPU）
  - 异常数据容错
  - 空数据处理

- **压力测试**
  - 大数据集处理
  - 高频采集
  - 长时间运行稳定性

- **集成测试**
  - 端到端流程
  - 数据持久化
  - 错误恢复

### 1.3 测试排除范围
- eBPF 集成（P2 功能，后续版本测试）
- 交叉引用功能（P2 功能，后续版本测试）
- 多云环境对比（未来功能）

---

## 2. 测试策略

### 2.1 测试层级
```
┌─────────────────────────────────────────┐
│         E2E 测试 (Integration)          │
│  - 完整业务流程                          │
│  - 命令行接口测试                        │
│  - 数据持久化测试                        │
└─────────────────────────────────────────┘
                    ▲
                    │
┌─────────────────────────────────────────┐
│         功能测试 (Functional)           │
│  - 数据采集功能                          │
│  - 异常检测功能                          │
│  - 分析功能                              │
└─────────────────────────────────────────┘
                    ▲
                    │
┌─────────────────────────────────────────┐
│         单元测试 (Unit)                 │
│  - 数据采集器                            │
│  - 检测算法                              │
│  - 数据模型                              │
└─────────────────────────────────────────┘
```

### 2.2 测试优先级
根据规格文档中的优先级定义：

**P0 - 必须实现（阻塞性测试）**
- AC 1: 数据采集准确性
- AC 2: 异常检测准确性
- AC 5: 命令行输出格式

**P1 - 首版本必备（高优先级）**
- AC 3: 进程分析完整性
- AC 4: 性能与资源占用
- AC 6: 历史数据查询

**P2 - 后续版本（低优先级）**
- AC 7: eBPF 集成
- AC 8: 交叉引用

### 2.3 测试方法
- **自动化测试**: 主要测试自动化，使用 pytest 框架
- **手工测试**: 辅助验证报告可视化、格式美观性
- **混沌测试**: 使用故障注入工具验证容错性
- **性能基准**: 建立性能基准，防止退化

---

## 3. 测试环境

### 3.1 硬件环境
- **CPU**: 4 核或以上
- **内存**: 8GB 或以上
- **磁盘**: 10GB 可用空间

### 3.2 软件环境
- **操作系统**: Ubuntu 20.04 LTS / CentOS 7+
- **Python**: Python 3.8+
- **依赖库**: 见规格文档依赖项章节

### 3.3 测试工具
- **测试框架**: pytest >= 7.0
- **覆盖率**: pytest-cov >= 4.0
- **性能测试**: pytest-benchmark >= 4.0
- **Mock 工具**: pytest-mock >= 3.10
- **报告生成**: pytest-html >= 3.0
- **混沌工具**: 自定义 chaos 模块

### 3.4 测试数据
- **正常负载数据**: 7 天历史数据
- **异常数据集**: 包含各种异常类型的标注数据
- **性能数据集**: 大规模数据用于性能测试
- **边界数据**: 极值和异常格式数据

---

## 4. 测试执行计划

### 4.1 测试阶段划分

#### 阶段 1: 单元测试 (2026-01-16 ~ 2026-01-18)
**目标**: 验证各个模块的正确性

**测试内容**:
- 数据采集器单元测试 (`tests/unit/test_cpu_collectors.py`)
  - 系统 CPU 采集器
  - 进程 CPU 采集器
  - 数据准确性验证

- 检测算法单元测试 (`tests/unit/test_detectors.py`)
  - 静态阈值检测
  - 动态基线检测
  - ML 算法检测
  - 检测准确性验证

- 数据模型测试
  - CPUMetric 模型
  - AnomalyEvent 模型
  - 数据验证

**通过标准**:
- 单元测试通过率 >= 98%
- 代码覆盖率 >= 80%
- 所有 P0 用例通过

#### 阶段 2: 集成测试 (2026-01-19 ~ 2026-01-21)
**目标**: 验证模块间协作和端到端流程

**测试内容**:
- 数据采集流程 (`tests/integration/test_e2e.py`)
  - 完整采集周期
  - 进程采集流程

- 异常检测流程
  - 采集 + 检测流程
  - 基线学习和检测

- 命令行接口测试
  - aiops collect 命令
  - aiops detect 命令
  - aiops analyze 命令
  - 输出格式验证

- 数据持久化测试
  - 数据保存和加载
  - CSV 导入导出

**通过标准**:
- 集成测试通过率 >= 95%
- 所有 AC 验收用例通过

#### 阶段 3: 性能和边界测试 (2026-01-22 ~ 2026-01-24)
**目标**: 验证性能指标和边界条件

**测试内容**:
- 性能测试 (`tests/performance/test_performance.py`)
  - 采集速度测试
  - 检测速度测试
  - 资源占用测试
  - 大数据集测试

- 边界测试
  - 0% / 100% CPU
  - 负值和极大值
  - 空数据和格式错误

- 压力测试
  - 高频采集
  - 长时间运行
  - 并发操作

**通过标准**:
- 满足所有性能要求（见 AC 4）
- 无资源泄漏
- 无性能退化

#### 阶段 4: 混沌测试 (2026-01-25 ~ 2026-01-26)
**目标**: 验证系统容错能力

**测试内容**:
- CPU 压力场景
  - 高负载检测
  - 单核过载
  - 进程争用

- 故障注入场景
  - /proc 文件读取失败
  - 数据格式损坏
  - 网络超时

- 复杂故障场景
  - 多故障同时发生
  - 错误恢复验证

**通过标准**:
- 系统能够优雅处理故障
- 不崩溃、不丢失数据
- 错误提示清晰

#### 阶段 5: 验收测试 (2026-01-27 ~ 2026-01-28)
**目标**: 验证所有验收标准

**测试内容**:
- 执行所有验收测试用例（见 `01-cpu-anomaly-detection-acceptance-tests.md`）
- AC 1-6 的完整验证
- 生成验收报告

**通过标准**:
- 所有 P0 用例 100% 通过
- P1 用例 >= 95% 通过
- 满足所有 AC 验收标准

#### 阶段 6: 回归测试 (2026-01-29 ~ 2026-01-30)
**目标**: 确保无功能退化

**测试内容**:
- 完整测试套件回归
- 性能基准对比
- 问题修复验证

**通过标准**:
- 所有测试用例通过
- 性能无退化
- 无回归缺陷

---

## 5. 测试用例统计

### 5.1 用例数量预估

| 测试类型 | 用例数量 | 自动化 | 预计工时 |
|---------|---------|--------|---------|
| 单元测试 | ~50 | 100% | 2 人日 |
| 集成测试 | ~30 | 90% | 1.5 人日 |
| 性能测试 | ~20 | 100% | 1 人日 |
| 边界测试 | ~15 | 100% | 0.5 人日 |
| 验收测试 | ~25 | 80% | 1 人日 |
| **总计** | **~140** | **95%** | **6 人日** |

### 5.2 重点用例清单

#### P0 用例（必须通过）
- AT-1.1: CPU 使用率采集准确性
- AT-1.2: 多核 CPU 数据采集
- AT-1.3: CPU 时间分量完整性
- AT-2.1: 静态阈值检测准确性
- AT-2.4: 检测延迟测试
- AT-5.1: JSON 输出格式验证
- AT-5.3: 表格输出格式验证

#### P1 用例（高优先级）
- AT-3.1: 进程 CPU 使用率准确性
- AT-3.2: 线程级别分析
- AT-4.1: 工具自身 CPU 占用
- AT-4.2: 内存占用测试
- AT-6.1: 时间范围查询
- AT-6.2: 查询性能测试

---

## 6. 质量目标

### 6.1 质量指标

| 指标 | 目标值 | 测量方法 |
|------|--------|---------|
| 功能测试通过率 | >= 98% | 自动化测试结果 |
| 验收测试通过率 | P0: 100%, P1: >= 95% | 验收测试报告 |
| 代码覆盖率 | >= 80% | pytest-cov |
| 性能达标率 | 100% | 性能测试报告 |
| 缺陷密度 | <= 0.5/KLOC | 缺陷跟踪系统 |
| 严重缺陷 | 0 | 缺陷跟踪系统 |

### 6.2 验收标准
所有以下条件满足即为通过验收：

1. ✅ 所有 P0 验收标准（AC 1, 2, 5）100% 达成
2. ✅ P1 验收标准（AC 3, 4, 6）达成率 >= 95%
3. ✅ 单元测试通过率 >= 98%
4. ✅ 代码覆盖率 >= 80%
5. ✅ 无严重和高级别缺陷
6. ✅ 性能指标满足 AC 4 要求
7. ✅ 文档完整（测试报告、用户手册）

---

## 7. 风险管理

### 7.1 测试风险识别

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| 测试环境不稳定 | 高 | 中 | 使用虚拟机/容器，准备快速恢复方案 |
| 测试数据不足 | 中 | 中 | 使用 Mock 数据生成器，补充真实数据 |
| 性能目标未达成 | 高 | 低 | 提前进行性能测试，预留优化时间 |
| 依赖功能未完成 | 高 | 中 | 使用 Mock 和桩模块，优先测试核心功能 |
| 测试时间不足 | 中 | 中 | 严格执行测试计划，优先 P0 用例 |

### 7.2 应对策略
- **环境风险**: 准备两套测试环境，主备切换
- **数据风险**: 自动化数据生成，减少人工准备
- **时间风险**: 建立每日跟踪机制，及时调整计划
- **人员风险**: 关键用例双人复核，知识共享

---

## 8. 交付物

### 8.1 测试文档
- ✅ 测试计划（本文档）
- ✅ 验收测试用例 (`01-cpu-anomaly-detection-acceptance-tests.md`)
- ✅ 测试报告模板
- ⬜ 最终测试报告（测试结束后生成）

### 8.2 测试代码
- ✅ 单元测试代码 (`tests/unit/`)
- ✅ 集成测试代码 (`tests/integration/`)
- ✅ 性能测试代码 (`tests/performance/`)
- ✅ Mock 数据生成器 (`tests/mocks/`)
- ✅ 混沌工程工具 (`chaos/`)

### 8.3 测试数据
- ✅ 正常负载数据集
- ✅ 异常数据集
- ✅ 性能测试数据集
- ✅ 边界测试数据

### 8.4 测试结果
- ⬜ 测试执行记录
- ⬜ 覆盖率报告 (HTML/XML)
- ⬜ 性能测试报告
- ⬜ 缺陷报告
- ⬜ 验收报告

---

## 9. 沟通计划

### 9.1 日常沟通
- **每日站会**: 测试进展、问题、风险
- **测试报告**: 每日自动发送测试结果

### 9.2 里程碑评审
- **单元测试完成** (2026-01-18)
- **集成测试完成** (2026-01-21)
- **性能测试完成** (2026-01-24)
- **验收测试完成** (2026-01-28)

### 9.3 问题升级路径
```
测试人员 -> 测试负责人 -> 开发负责人 -> 项目经理
```

---

## 10. 审批

| 角色 | 姓名 | 签名 | 日期 |
|------|------|------|------|
| 测试负责人 | aiops-cli-tester | | 2026-01-16 |
| 开发负责人 | | | |
| 项目经理 | | | |
| 质量保证 | | | |

---

## 附录

### A. 测试环境搭建
详见: `/tests/README.md`

### B. 测试工具使用指南
详见: `/chaos/README.md`

### C. 测试数据生成指南
详见: `/tests/mocks/README.md`

### D. 变更记录
| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|---------|--------|
| v1.0 | 2026-01-16 | 初始版本 | aiops-cli-tester |
