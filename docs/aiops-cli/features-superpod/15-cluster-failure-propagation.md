# 特性 15: 集群级故障传播与影响分析

## 功能概述

提供集群级故障传播分析和影响评估能力,追踪故障如何在集群中传播,评估故障影响范围和严重程度,识别级联故障模式,实现故障快速定位和影响范围控制。

## 用户场景

**场景 1: 集群大面积故障,需要分析传播路径**
- 一个节点故障导致多个服务不可用
- 需要分析故障如何在集群中传播
- 使用 `aiops analyze-failure-propagation --start-node <node>` 分析传播

**场景 2: 评估故障影响范围**
- 某个关键服务故障,需要评估影响范围
- 需要识别受影响的用户和业务
- 使用 `aiops assess-impact --service <service>` 评估影响

**场景 3: 级联故障预警**
- 检测到可能导致级联故障的风险点
- 需要提前预警和防护
- 使用 `aiops predict-cascade --cluster <cluster>` 预测级联故障

## 技术方案概要

### 故障传播建模
- **故障传播图**: 构建集群故障传播有向图
- **传播概率**: 计算故障在节点间传播的概率
- **传播速度**: 分析故障传播的速度和模式
- **传播阈值**: 识别触发级联故障的阈值

### 影响评估
- **服务影响**: 评估受影响的服务数量和类型
- **用户影响**: 估算受影响的用户数量和业务损失
- **数据影响**: 评估数据丢失和损坏风险
- **恢复时间**: 估算 MTTR 和恢复时间

## 核心功能点

### 1. 故障传播路径分析
```bash
# 分析故障传播路径
aiops analyze-failure-propagation --start-node <node>
```

### 2. 影响范围评估
```bash
# 评估故障影响
aiops assess-impact --service <service>
```

### 3. 级联故障预测
```bash
# 预测级联故障风险
aiops predict-cascade --cluster <cluster>
```

### 4. 故障隔离建议
```bash
# 生成故障隔离建议
aiops recommend-isolation --failure-type <type>
```

## 验收标准

### AC 1: 传播路径准确性
- **Given**: 已知故障传播路径
- **When**: 执行 `aiops analyze-failure-propagation`
- **Then**: 传播路径准确率 >= 80%

### AC 2: 影响评估准确性
- **Given**: 服务故障影响 5 个下游服务
- **When**: 执行 `aiops assess-impact`
- **Then**: 影响范围准确率 >= 85%

### AC 3: 性能要求
- **Given**: 100 节点集群
- **When**: 执行故障传播分析
- **Then**: 分析时间 < 120 秒

## 依赖项

```
kubernetes>=24.0.0
networkx>=3.1
pandas>=2.0.0
numpy>=1.24.0
scikit-learn>=1.3.0
click>=8.1.0
rich>=13.0.0
```

## 优先级

**P0**: AC 1, 核心功能点 1
**P1**: AC 2, AC 3, 核心功能点 2, 3
**P2**: 核心功能点 4

## 输出示例

### 故障传播分析输出
```bash
$ aiops analyze-failure-propagation --start-node node-1

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 故障传播分析                                          2024-01-15 14:30:25 ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 起始节点: node-1                                               │
│ 故障类型: 数据库连接池耗尽                                      │
│ 开始时间: 2024-01-15 14:15:00                                 │
├──────────────────────────────────────────────────────────────────┤
│ 📊 传播路径:                                                     │
│   node-1 (14:15:00) → node-2,3 (14:16:00)                     │
│     → node-5,6,7 (14:18:00) → [停止于 14:20:00]               │
│   总影响节点: 6 个 (12%)                                       │
│   传播深度: 3 层                                               │
│   传播速度: 2 节点/分钟                                         │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 🎯 关键传播节点:                                                  │
│   node-1: 故障源头                                              │
│   node-2,3: 关键传播节点(无熔断保护)                            │
│   node-5: 阻断节点(有熔断器)                                    │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 级联故障预测输出
```bash
$ aiops predict-cascade --cluster superpod-1

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 级联故障预测                                          2024-01-15 14:30:25 ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 集群: superpod-1                                               │
│ 分析时间: 2024-01-15 14:00:00 - 14:30:00                      │
├──────────────────────────────────────────────────────────────────┤
│ ⚠️  风险评估:                                                    │
│   级联故障风险: 中等 (风险评分: 65/100)                        │
│   预计影响节点: 8-15 个 (如果触发)                              │
│   预计影响服务: 12-20 个                                        │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 🚨 高风险节点:                                                   │
│   node-3 (风险评分: 85/100)                                    │
│     风险因素: 无熔断保护、高依赖度                               │
│     建议: 增加熔断器                                            │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

## 后续演进方向

1. **自动故障隔离**: 自动隔离高风险节点
2. **实时传播监控**: 实时监控故障传播
3. **自愈能力**: 自动修复故障节点
4. **多集群故障传播**: 支持跨集群故障传播分析
