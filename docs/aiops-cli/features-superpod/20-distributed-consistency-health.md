# 特性 20: 分布式一致性与健康检查

## 功能概述

提供分布式系统一致性状态监控和健康检查能力,针对 Kubernetes 集群中运行的有状态服务(数据库、消息队列、分布式缓存等),监控其复制状态、数据一致性、Leader 选举、分区容忍性,识别分布式系统的健康问题和风险。

## 用户场景

**场景 1: 数据库主从同步延迟**
- MySQL 主从同步延迟增大
- 需要分析延迟原因和影响
- 使用 `aiops check-replication --database mysql` 检查复制状态

**场景 2: 分布式缓存脑裂**
- Redis Cluster 出现脑裂(网络分区)
- 需要检测和诊断脑裂问题
- 使用 `aiops diagnose-split-brain --cluster redis` 诊断脑裂

**场景 3: 分布式一致性健康评估**
- Etcd 集群健康度下降
- 需要评估一致性和可用性
- 使用 `aiops assess-consistency --cluster etcd` 评估一致性

## 技术方案概要

### 一致性监控
- **复制延迟**: 监控主从复制延迟
- **数据一致性**: 检查数据一致性(校验和、版本号)
- **Leader 状态**: 监控 Leader 选举和状态
- **分区状态**: 检测网络分区和脑裂

### 健康检查
- **Raft/Paxos 状态**: 监控共识算法状态
- **节点健康**: 检查分布式节点的健康度
- **投票权**: 检查节点的投票权和法定人数
- **数据完整性**: 检查数据完整性

## 核心功能点

### 1. 复制状态检查
```bash
# 检查数据库复制状态
aiops check-replication --database <mysql|postgres|mongo>
```

### 2. 脑裂检测
```bash
# 检测脑裂
aiops detect-split-brain --cluster <redis|etcd>
```

### 3. 一致性评估
```bash
# 评估分布式一致性
aiops assess-consistency --cluster <cluster-name>
```

### 4. Leader 选举监控
```bash
# 监控 Leader 选举
aiops monitor-leader --cluster <cluster-name>
```

## 验收标准

### AC 1: 复制延迟检测准确性
- **Given**: MySQL 主从延迟 50 秒
- **When**: 执行 `aiops check-replication`
- **Then**: 延迟检测准确(误差 < 10%)

### AC 2: 脑裂检测准确性
- **Given**: Redis Cluster 出现脑裂
- **When**: 执行 `aiops detect-split-brain`
- **Then**: 检测准确率 >= 85%

### AC 3: 一致性评估准确性
- **Given**: Etcd 集群一致性问题(日志不匹配)
- **When**: 执行 `aiops assess-consistency`
- **Then**: 评估准确率 >= 80%

### AC 4: 性能要求
- **Given**: 分布式集群 5 个节点
- **When**: 执行一致性检查
- **Then**: 检查时间 < 30 秒

## 依赖项

```
kubernetes>=24.0.0
pandas>=2.0.0
numpy>=1.24.0
click>=8.1.0
rich>=13.0.0
pyyaml>=6.0
```

### 数据库/存储客户端
- 需要访问分布式系统的管理端口或 API
- 例如: Redis、Etcd、MySQL、MongoDB 等

## 优先级

**P0**: AC 1, 核心功能点 1
**P1**: AC 2, AC 3, AC 4, 核心功能点 2, 3
**P2**: 核心功能点 4

## 输出示例

### 复制状态检查输出
```bash
$ aiops check-replication --database mysql

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 数据库复制状态检查                                    2024-01-15 14:30:25 ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 数据库: MySQL 8.0                                              │
│ 主库: mysql-primary (Pod: mysql-0)                            │
│ 从库数量: 2                                                    │
├──────────────────────────────────────────────────────────────────┤
│ 📊 复制状态:                                                     │
│                                                                  │
│   主库 (mysql-primary): ✅ 健康                                 │
│     状态: Online                                               │
│     连接数: 145                                                │
│     TPS: 850                                                   │
│                                                                  │
│   从库 #1 (mysql-replica-1): ⚠️ 延迟高                         │
│     状态: Online                                               │
│     复制延迟: 52.3 秒 🚨 (基线: < 1s, +5130%)                 │
│     IO 线程: Running                                           │
│     SQL 线程: Running                                          │
│     Relay Log: 正常                                            │
│     距离主库: 657,892 bytes                                    │
│     问题: 延迟过高,可能影响读一致性                            │
│     建议:                                                      │
│       • 检查网络延迟                                            │
│       • 检查从库负载                                            │
│       • 考虑调整复制模式(并行复制)                              │
│                                                                  │
│   从库 #2 (mysql-replica-2): ✅ 健康                            │
│     状态: Online                                               │
│     复制延迟: 0.8 秒                                           │
│     IO 线程: Running                                           │
│     SQL 线程: Running                                          │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 🔍 延迟分析:                                                      │
│   mysql-replica-1 延迟根因:                                      │
│     假设 #1: 网络延迟 (置信度: 65%)                             │
│       证据: 主库到从库网络延迟 +200ms                           │
│     假设 #2: 从库负载高 (置信度: 45%)                           │
│       证据: 从库 CPU 使用率 85%                                │
│     假设 #3: 慢查询 (置信度: 30%)                              │
│       证据: 从库有 2 个慢查询(> 10s)                           │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 💡 建议:                                                         │
│   1. 立即:                                                       │
│      • 检查网络连接质量                                          │
│      • 检查从库负载                                             │
│   2. 短期:                                                       │
│      • 优化慢查询                                                │
│      • 考虑增加从库                                              │
│   3. 长期:                                                       │
│      • 配置复制监控告警                                          │
│      • 考虑使用 GTID 和并行复制                                 │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 脑裂检测输出
```bash
$ aiops detect-split-brain --cluster redis

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 脑裂检测                                              2024-01-15 14:30:25 ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 集群: redis-cluster                                            │
│ 节点数: 6 (3 master + 3 slave)                                │
├──────────────────────────────────────────────────────────────────┤
│ 🔍 检测结果:                                                     │
│   状态: ⚠️ 潜在脑裂风险                                        │
│   风险等级: Medium                                            │
│   置信度: 75%                                                  │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 📊 节点状态:                                                     │
│                                                                  │
│   分区 #1 (3 节点):                                             │
│     • redis-master-1: Master, Slot 0-5460                      │
│     • redis-master-2: Master, Slot 5461-10922                 │
│     • redis-slave-1: Slave (of master-1)                      │
│     状态: ✅ 正常 (达到法定人数 3/3)                          │
│                                                                  │
│   分区 #2 (3 节点):                                             │
│     • redis-master-3: Master, Slot 10923-16383                │
│     • redis-slave-2: Slave (of master-2)                     │
│     • redis-slave-3: Slave (of master-3)                     │
│     状态: ⚠️ 孤立 (无法达到法定人数)                           │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 🚨 脑裂特征:                                                      │
│   1. 存在两个独立的分区                                         │
│   2. 分区 #2 无法写入(无法达到法定人数)                         │
│   3. 网络分区持续 3 分钟                                        │
│   4. 有数据不一致风险                                           │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 💡 修复建议:                                                      │
│   1. 立即修复网络分区                                            │
│   2. 检查网络策略和防火墙                                        │
│   3. 重启受影响的节点                                           │
│   4. 验证集群状态:                                              │
│      redis-cli --cluster check <any-node>                     │
│   5. 必要时手动修复集群:                                         │
│      redis-cli --cluster fix <any-node>                       │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 🛡️ 预防措施:                                                      │
│   1. 配置 cluster-require-full-coverage yes                    │
│   2. 增加监控告警                                               │
│   3. 配置网络策略                                               │
│   4. 定期演练故障恢复                                           │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

## 后续演进方向

1. **自动修复**: 自动修复常见的分布式一致性问题
2. **预测性维护**: 预测复制延迟和脑裂风险
3. **多集群一致性**: 支持跨集群的一致性检查
4. **一致性可视化**: 可视化分布式系统的状态和拓扑
