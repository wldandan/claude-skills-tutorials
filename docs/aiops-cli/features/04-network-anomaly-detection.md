# 特性 04: 网络异常检测与分析

## 功能概述

提供网络性能异常检测和故障诊断能力，涵盖网络连接异常、带宽瓶颈、延迟突增、丢包、连接数过多等问题。通过分析网络流量、连接状态、TCP/IP 协议栈指标，快速定位网络问题的层次（物理层、网络层、传输层、应用层）和根本原因。

## 用户场景

**场景 1: 网络连接超时**
- 应用程序频繁报告连接超时
- 需要判断是网络问题还是服务问题
- 使用 `aiops diagnose connectivity --host <target>` 诊断网络连通性

**场景 2: 带宽异常占用**
- 网络带宽突然被占满，其他服务受影响
- 需要找出占用带宽的进程和连接
- 使用 `aiops analyze bandwidth --processes` 识别带宽占用者

**场景 3: 连接数耗尽**
- 服务无法接受新连接（Too many open files）
- 需要分析连接状态分布（TIME_WAIT/CLOSE_WAIT）
- 使用 `aiops analyze connections --state` 查看连接状态

## 技术方案概要

### 数据采集层
- 读取 `/proc/net/netstat`、`/proc/net/snmp` 获取 TCP/IP 协议栈统计
- 读取 `/proc/net/tcp`、`/proc/net/udp` 获取连接列表
- 读取 `/proc/net/sockstat` 获取套接字统计
- 读取 `/proc/sys/net/ipv4/*` 获取内核网络参数
- 使用 `ss`、`netstat` 获取详细连接信息
- 使用 `ethtool` 获取网卡统计和状态
- 使用 `iftop`、`nethogs` 监控带宽占用
- 使用 eBPF 追踪网络数据包和连接

### 异常检测算法
- **带宽异常**: 检测网卡带宽使用率突增或持续过高
- **连接数异常**: 检测连接数突增或超过内核限制
- **延迟异常**: 检测网络延迟（RTT）突增
- **丢包异常**: 检测丢包率突增（TCP Retransmission）
- **重传异常**: 检测 TCP 重传率突增

### 根因分析
- **分层诊断**: 物理层（网卡状态）→ 网络层（路由、ICMP）→ 传输层（TCP/UDP）→ 应用层（端口）
- **进程级带宽**: 列出发送/接收流量最多的进程
- **连接状态分析**: 统计 ESTABLISHED/TIME_WAIT/CLOSE_WAIT 等状态分布
- **热点连接**: 识别流量最大的连接（本地地址:端口 <-> 远程地址:端口）
- **关联分析**: 关联同时间段的系统日志（dmesg、messages）

## 核心功能点

### 1. 网络连通性诊断
```bash
# 诊断到目标主机的网络连通性
aiops diagnose connectivity --host example.com --port 443
```
- 多层次诊断（ICMP ping、TCP connect、HTTP 请求）
- 测试 MTU、路由追踪
- 检测 DNS 解析
- 测量延迟和丢包
- 生成诊断报告和建议

### 2. 带宽分析
```bash
# 分析网络带宽使用情况
aiops analyze bandwidth --interface eth0 --processes
```
- 显示网卡带宽使用率（Rx/Tx）
- 列出占用带宽最多的进程和连接
- 流量趋势图（时序）
- 识别异常流量峰值

### 3. 连接分析
```bash
# 分析网络连接状态
aiops analyze connections --state --processes
```
- 统计各状态连接数（ESTABLISHED/TIME_WAIT/CLOSE_WAIT 等）
- 列出连接数最多的进程
- 检测连接泄露（持续增长）
- 显示连接详情（本地/远程地址、端口、进程）

### 4. TCP 协议栈分析
```bash
# 分析 TCP 协议栈指标
aiops analyze tcp --detail
```
- 显示 TCP 统计（/proc/net/netstat）
- 分析重传率、丢包率
- 分析 TCP 窗口缩放、拥塞控制算法
- 显示内核 TCP 参数（tcp_tw_reuse、tcp_tw_recycle 等）
- 提供参数调优建议

### 5. 网络性能监控
```bash
# 实时监控网络性能
aiops monitor network --interval 1
```
- 实时显示网卡流量（Rx/Tx bytes/packets）
- 实时显示连接数、错误数、丢包数
- 实时显示 TCP 统计（活跃打开、被动打开、重传等）
- 异常指标高亮

### 6. 端口监听分析
```bash
# 分析系统监听端口
aiops analyze listening --processes
```
- 列出所有监听端口和对应进程
- 检测端口冲突（多个进程监听同一端口）
- 显示端口绑定地址（0.0.0.0 或特定 IP）
- 检测非预期监听端口（安全风险）

### 7. 网络异常检测
```bash
# 检测网络异常事件
aiops detect network-anomaly --time-range 1h
```
- 检测带宽异常（突发流量）
- 检测连接数异常（DDoS 攻击、连接泄露）
- 检测延迟异常（网络拥塞）
- 检测丢包/重传异常
- 生成异常报告和根因分析

### 8. 防火墙和 NAT 分析
```bash
# 分析防火墙规则和 NAT 连接
aiops analyze firewall --rules --conntrack
```
- 显示 iptables/nftables 规则列表
- 分析 conntrack 表使用率
- 检测 conntrack 表满（连接跟踪满）
- 提供防火墙优化建议

## 验收标准 (Acceptance Criteria)

### AC 1: 网络数据采集准确性
- **Given**: Linux 系统网络正常
- **When**: 执行 `aiops collect network --duration 60s`
- **Then**:
  - 采集的网卡流量与 `ifconfig` 或 `ip -s link` 一致（误差 < 2%）
  - 采集的连接数与 `ss -s` 一致（误差 < 1%）
  - TCP 统计与 `/proc/net/netstat` 一致

### AC 2: 连通性诊断准确性
- **Given**: 目标主机可达
- **When**: 执行 `aiops diagnose connectivity --host example.com --port 443`
- **Then**:
  - ICMP ping 成功率与实际一致
  - TCP connect 结果正确（能连接/不能连接）
  - 延迟测量误差 < 10%（与 ping 对比）
  - 正确识别网络故障层次（L1/L2/L3/L4/L7）

### AC 3: 带宽分析准确性
- **Given**: 系统有网络流量
- **When**: 执行 `aiops analyze bandwidth --interface eth0 --processes`
- **Then**:
  - 网卡带宽使用率计算正确
  - 进程带宽占用排序正确（基于 /proc/<pid>/net/dev）
  - 总流量与网卡流量一致（误差 < 10%）

### AC 4: 连接分析准确性
- **Given**: 系统有大量网络连接
- **When**: 执行 `aiops analyze connections --state`
- **Then**:
  - 各状态连接数统计准确（与 `ss -s` 对比误差 < 2%）
  - 连接详情准确（IP、端口、进程 PID）
  - 能正确识别 TIME_WAIT/CLOSE_WAIT 等异常状态

### AC 5: TCP 协议栈分析完整性
- **Given**: 系统运行正常
- **When**: 执行 `aiops analyze tcp --detail`
- **Then**:
  - 正确读取 `/proc/net/netstat` 的所有 TCP 指标
  - 重传率、丢包率计算正确
  - 内核 TCP 参数显示正确
  - 提供的调优建议合理

### AC 6: 性能与资源占用
- **Given**: 系统正常运行
- **When**: 启动 `aiops monitor network --daemon` 后台运行
- **Then**:
  - 工具自身 CPU 占用 < 3%（单核）
  - 内存占用 < 120MB
  - 网络流量 < 1MB/day（仅采集指标，不抓包）

### AC 7: 异常检测准确性
- **Given**: 系统存在网络异常（如丢包率 > 5%）
- **When**: 执行 `aiops detect network-anomaly --time-range 1h`
- **Then**:
  - 检测到异常事件，准确率 >= 85%（基于标注测试集）
  - 误报率 <= 15%
  - 检测延迟 <= 60 秒

### AC 8: 防火墙分析
- **Given**: 系统配置了防火墙规则
- **When**: 执行 `aiops analyze firewall --rules`
- **Then**:
  - 正确读取 iptables/nftables 规则
  - 显示规则条数和链
  - 检测规则冲突或错误

## 依赖项

### 系统依赖
- **操作系统**: Linux (内核 >= 3.10)
- **Python**: Python 3.8+
- **工具**: ss、ip、ping、traceroute（系统自带）
- **权限**: 普通用户权限，部分功能需要 root

### Python 库依赖
```
psutil>=5.9.0          # 网络接口和连接采集
pandas>=2.0.0          # 数据处理
numpy>=1.24.0          # 数值计算
scikit-learn>=1.3.0    # 异常检测
click>=8.1.0           # CLI 框架
rich>=13.0.0           # 终端美化
```

### 可选依赖
```
scapy>=2.5.0           # 数据包构造和分析（连通性测试）
bpfcc>=0.20.0          # eBPF 工具（进程带宽追踪）
```

## 优先级

**P0 (必须实现)**
- AC 1: 网络数据采集准确性
- AC 4: 连接分析准确性
- AC 6: 性能与资源占用
- 核心功能点 3, 5

**P1 (首版本必备)**
- AC 2: 连通性诊断
- AC 3: 带宽分析
- AC 5: TCP 协议栈分析
- 核心功能点 1, 2, 4

**P2 (后续版本优化)**
- AC 7: 异常检测
- AC 8: 防火墙分析
- 核心功能点 6, 7, 8

## 输出示例

### 连通性诊断输出
```bash
$ aiops diagnose connectivity --host example.com --port 443

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 网络连通性诊断报告                                  2024-01-15 14:30:25 ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 目标主机: example.com (93.184.216.34)                          │
│ 目标端口: 443 (HTTPS)                                           │
├──────────────────────────────────────────────────────────────────┤
│ ✅ 第 1 层 - 物理层: 通过                                          │
│    网卡: eth0 (UP, RUNNING)                                     │
│    速率: 1000 Mbps                                              │
├──────────────────────────────────────────────────────────────────┤
│ ✅ 第 2 层 - 数据链路层: 通过                                      │
│    MAC 地址: 00:11:22:33:44:55                                  │
│    MTU: 1500 bytes                                              │
├──────────────────────────────────────────────────────────────────┤
│ ✅ 第 3 层 - 网络层: 通过                                          │
│    ICMP Ping: 成功 (RTT: 12.5ms)                                │
│    TTL: 54                                                      │
│    路由追踪:                                                     │
│      1. 192.168.1.1 (1.2ms)                                    │
│      2. 10.0.0.1 (5.8ms)                                       │
│      3. 202.96.128.86 (8.3ms)                                  │
│      ... (跳过)                                                 │
│      11. 93.184.216.34 (12.5ms) ✅                              │
├──────────────────────────────────────────────────────────────────┤
│ ✅ DNS 解析: 通过                                                  │
│    域名: example.com                                            │
│    解析 IP: 93.184.216.34                                       │
│    DNS 服务器: 8.8.8.8 (查询时间: 8ms)                          │
├──────────────────────────────────────────────────────────────────┤
│ ✅ 第 4 层 - 传输层: 部分通过                                      │
│    TCP Connect to 93.184.216.34:443: 成功                        │
│    TCP 建立时间: 18.3ms                                         │
│    SSL/TLS 握手: 成功 (TLS 1.3)                                 │
│    证书验证: 通过                                                │
├──────────────────────────────────────────────────────────────────┤
│ ⚠️  第 7 层 - 应用层: 响应慢                                       │
│    HTTP 请求: GET /                                              │
│    HTTP 状态码: 200 OK                                          │
│    HTTP 响应时间: 2.8s ⚠️  (正常 < 1s)                            │
│    HTTP 头部:                                                     │
│      Server: ECS (dcb/7EDB)                                     │
│      Content-Type: text/html                                    │
├──────────────────────────────────────────────────────────────────┤
│ 📊 性能总结:                                                       │
│   总延迟: 2.8s (其中应用响应: 2.76s, 网络: 0.04s)                 │
│   瓶颈在: 应用层 (目标服务器响应慢)                                │
│                                                                  │
│ 💡 建议:                                                          │
│   - 网络层面无问题                                                │
│   - 应用响应慢，联系应用团队检查 example.com 后端服务              │
│   - 检查目标服务器负载和日志                                       │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 连接分析输出
```bash
$ aiops analyze connections --state --processes

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 网络连接分析                                         2024-01-15 14:30:25 ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 采样时间: 2024-01-15 14:30:25                                   │
├──────────────────────────────────────────────────────────────────┤
│ 📊 连接状态统计:                                                   │
│   总连接数: 12,458                                               │
│   ┌─────────────────┬──────────┬────────┬──────────────┐       │
│   │ 状态            │   数量   │ 占比   │ 说明         │       │
│   ├─────────────────┼──────────┼────────┼──────────────┤       │
│   │ ESTABLISHED     │  8,523   │ 68.4%  │ 活跃连接     │       │
│   │ TIME_WAIT       │  3,124   │ 25.1%  │ ⚠️  过多      │       │
│   │ CLOSE_WAIT      │    542   │  4.4%  │ ⚠️  可能泄露  │       │
│   │ LISTEN          │    256   │  2.1%  │ 监听端口     │       │
│   │ LAST_ACK        │     13   │  0.1%  │ ⚠️  异常      │       │
│   └─────────────────┴──────────┴────────┴──────────────┘       │
│                                                                  │
│ ⚠️  检测到问题:                                                    │
│   1. TIME_WAIT 连接过多 (3,124)                                   │
│      - 可能原因: 短连接频繁、不使用连接池                           │
│      - 建议: 调整 net.ipv4.tcp_tw_reuse=1                        │
│   2. CLOSE_WAIT 连接较多 (542)                                    │
│      - 可能原因: 应用程序未正确关闭连接                            │
│      - 建议: 检查应用程序代码，确保关闭连接                         │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 🔝 Top 10 连接数最多进程:                                          │
│   ┌──────┬───────────────┬──────────┬────────┬────────────────┐  │
│   │ PID  │ 进程名        │ 连接数   │ 状态   │ 本地地址       │  │
│   ├──────┼───────────────┼──────────┼────────┼────────────────┤  │
│   │ 1523 │ nginx        │   3,245  │ ESTAB  │ 0.0.0.0:443   │  │
│   │ 2891 │ mysqld       │   2,156  │ ESTAB  │ 0.0.0.0:3306  │  │
│   │ 5421 │ java         │   1,892  │ ESTAB  │ 0.0.0.0:8080  │  │
│   │ 8923 │ redis-server │     892  │ ESTAB  │ 0.0.0.0:6379  │  │
│   │ ...  │ ...          │     ...  │ ...    │ ...           │  │
│   └──────┴───────────────┴──────────┴────────┴────────────────┘  │
│                                                                  │
│ 🔍 连接详情示例 (Top 5):                                           │
│   1. [ESTAB] 192.168.1.100:443 <- 10.0.0.5:52341 (nginx)        │
│   2. [ESTAB] 192.168.1.100:3306 <- 192.168.1.101:45623 (mysqld)  │
│   3. [TIME_WAIT] 192.168.1.100:80 -> 172.16.0.5:12345 (nginx)   │
│   4. [CLOSE_WAIT] 192.168.1.100:8080 <- 10.0.1.10:62341 (java)  │
│   5. [ESTAB] 192.168.1.100:6379 <- 192.168.1.102:54321 (redis)  │
│                                                                  │
│ 💡 内核参数建议:                                                   │
│   当前值 -> 建议值:                                               │
│   - net.ipv4.tcp_tw_reuse: 0 -> 1 (复用 TIME_WAIT 连接)          │
│   - net.core.somaxconn: 128 -> 4096 (增加监听队列)               │
│   - net.ipv4.tcp_max_syn_backlog: 512 -> 8192 (增加 SYN 队列)    │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

## 后续演进方向

1. **DDoS 检测**: 检测分布式拒绝服务攻击（SYN flood、UDP flood）
2. **应用层协议分析**: 深度包检测 HTTP、DNS、Redis、MySQL 等协议
3. **网络拓扑发现**: 自动发现网络设备和拓扑关系
4. **流量特征分析**: 识别流量模式（视频、下载、数据库等）
