# 特性 06: 智能日志分析与异常检测

## 功能概述

提供智能化的日志分析和异常检测能力，涵盖日志采集、解析、模式识别、异常检测、根因定位等功能。通过机器学习和规则引擎，自动识别日志中的错误模式、异常行为、性能问题，并关联日志事件与系统指标，加速问题定位和根因分析。

## 用户场景

**场景 1: 大量日志中快速定位错误**
- 应用产生海量日志，其中包含少量错误
- 需要快速筛选出错误日志和异常模式
- 使用 `aiops logs --level error --tail 1000` 过滤错误日志

**场景 2: 日志模式识别和分类**
- 日志包含多种类型的错误，需要分类统计
- 需要识别错误发生的频率和趋势
- 使用 `aiops logs --pattern-detect --period 1h` 自动识别日志模式

**场景 3: 关联日志与系统事件**
- 系统崩溃，需要查看崩溃前后的日志
- 需要关联日志与系统指标（CPU、内存）
- 使用 `aiops logs --correlate --time-range 10m` 关联分析

## 技术方案概要

### 日志采集层
- 读取常见日志文件：`/var/log/messages`、`/var/log/syslog`、`/var/log/dmesg`
- 读取应用日志：支持配置自定义日志路径
- 读取 systemd 日志：`journalctl`
- 实时追踪：`tail -f` 模式
- 支持多种日志格式：syslog、JSON、纯文本、应用自定义格式

### 日志解析与标准化
- **正则表达式提取**: 提取时间戳、日志级别、进程、消息内容
- **自动解析**: 基于 ML 的日志模板提取（Drain、Spell 算法）
- **多行聚合**: 将多行日志聚合成单个事件（如 Java 堆栈）
- **时间戳解析**: 支持多种时间格式（ISO8601、Unix 时间戳、自定义）

### 异常检测算法
- **关键词匹配**: 基于规则的错误关键词（error、exception、fatal、panic）
- **日志级别异常**: 检测 ERROR/FATAL 级别日志突增
- **模式异常**: 检测罕见的日志模板（出现频率 < 阈值）
- **频率异常**: 检测日志量突增（日志风暴）
- **序列异常**: 检测异常的日志序列模式（如失败后的重试模式）

### 根因分析
- **时间窗口分析**: 在异常时间窗口内聚合所有相关日志
- **日志模板聚类**: 将相似日志聚类，识别主要错误模式
- **前因后果**: 识别异常前的日志事件（前兆）和异常后的影响
- **多源关联**: 关联系统日志、应用日志、内核日志
- **指标关联**: 关联同时间段的系统指标（CPU、内存、网络）

## 核心功能点

### 1. 日志查询与过滤
```bash
# 查询和过滤日志
aiops logs --path /var/log/app.log --level error --tail 100
```
- 支持多种过滤条件（级别、时间范围、关键词、正则表达式）
- 支持多日志文件聚合查询
- 支持实时追踪（tail -f）
- 输出格式：表格、JSON、原始日志

### 2. 日志模式识别
```bash
# 识别日志模式
aiops logs --pattern-detect --period 1h --top 20
```
- 自动提取日志模板（Log Parsing）
- 统计每个模板的出现频率
- 识别最常见的日志模式（Top N）
- 识别罕见的日志模式（异常）

### 3. 异常日志检测
```bash
# 检测异常日志
aiops logs --anomaly-detect --time-range 1h
```
- 检测异常日志模板（出现频率异常）
- 检测日志级别异常（ERROR 突增）
- 检测日志量异常（日志风暴）
- 检测新出现的日志模板

### 4. 错误日志聚合
```bash
# 聚合错误日志
aiops logs --aggregate-errors --period 1d
```
- 将相似的错误日志聚合
- 统计每个错误类型的次数
- 显示错误的时间分布
- 识别最频繁的错误

### 5. 日志关联分析
```bash
# 关联日志与系统指标
aiops logs --correlate --time-range 10m --anomaly-time 14:15:00
```
- 在异常时间窗口内提取所有日志
- 关联系统指标（CPU、内存、网络）
- 识别异常的前兆日志（Early Warning）
- 生成事件时间线

### 6. 日志统计与报告
```bash
# 生成日志统计报告
aiops logs --stats --period 1d
```
- 日志级别分布（INFO/WARN/ERROR/FATAL）
- 日志量趋势（时序图）
- Top 日志源（进程、主机）
- Top 错误类型

### 7. 日志搜索
```bash
# 搜索日志内容
aiops logs --search "connection timeout" --context 3
```
- 支持关键词搜索
- 支持正则表达式搜索
- 显示匹配日志的上下文（前后 N 行）
- 高亮匹配关键词

### 8. 日志导出
```bash
# 导出日志
aiops logs --export --format json --output logs.json
```
- 导出为 JSON、CSV、纯文本
- 支持压缩（gzip）
- 支持时间范围过滤
- 支持字段选择

## 验收标准 (Acceptance Criteria)

### AC 1: 日志采集准确性
- **Given**: 系统有日志文件
- **When**: 执行 `aiops logs --path /var/log/syslog --tail 100`
- **Then**:
  - 采集的日志内容与原始文件一致
  - 日志条数正确（tail 100 条）
  - 时间戳解析准确（支持 ISO8601 和常见格式）

### AC 2: 日志解析准确性
- **Given**: 日志包含标准格式（时间、级别、进程、消息）
- **When**: 执行 `aiops logs --path /var/log/app.log --parse`
- **Then**:
  - 正确解析时间戳（准确率 >= 99%）
  - 正确识别日志级别（INFO/WARN/ERROR）
  - 正确提取进程名和 PID

### AC 3: 模式识别准确性
- **Given**: 日志包含多种模式（1 万条日志）
- **When**: 执行 `aiops logs --pattern-detect`
- **Then**:
  - 识别的日志模板覆盖率 >= 95%
  - 模板提取的 F1-score >= 0.9（基于标注数据）
  - 处理速度 >= 10000 条/秒

### AC 4: 异常检测准确性
- **Given**: 日志包含异常事件（错误、罕见模式）
- **When**: 执行 `aiops logs --anomaly-detect --time-range 1h`
- **Then**:
  - 检测到异常日志，准确率 >= 85%（基于标注测试集）
  - 误报率 <= 15%
  - 检测延迟 <= 10 秒（实时模式）

### AC 5: 日志过滤性能
- **Given**: 日志文件 1GB
- **When**: 执行 `aiops logs --path /var/log/app.log --level error`
- **Then**:
  - 过滤时间 < 30 秒
  - 内存占用 < 500MB
  - 不漏掉任何匹配的日志

### AC 6: 日志关联分析
- **Given**: 存在系统异常事件
- **When**: 执行 `aiops logs --correlate --anomaly-time <timestamp>`
- **Then**:
  - 正确提取异常时间窗口内的日志
  - 关联同时间段的系统指标
  - 识别可能的前兆日志

### AC 7: 日志搜索准确性
- **Given**: 日志文件包含特定关键词
- **When**: 执行 `aiops logs --search "error" --context 3`
- **Then**:
  - 找到所有包含关键词的日志
  - 显示上下文正确（前后 3 行）
  - 搜索性能 >= 10MB/秒

### AC 8: 多日志源支持
- **Given**: 系统有多个日志文件
- **When**: 执行 `aiops logs --path /var/log/* --tail 1000`
- **Then**:
  - 正确读取多个日志文件
  - 按时间顺序合并日志
  - 保留日志源信息（文件名）

## 依赖项

### 系统依赖
- **操作系统**: Linux (内核 >= 3.10)
- **Python**: Python 3.8+
- **权限**: 普通用户权限（读取日志），部分日志需要 root

### Python 库依赖
```
pandas>=2.0.0          # 日志数据处理
numpy>=1.24.0          # 数值计算
click>=8.1.0           # CLI 框架
rich>=13.0.0           # 终端美化
regex>=2023.0.0        # 高级正则表达式
python-dateutil>=2.8.0 # 时间解析
```

### 可选依赖
```
scikit-learn>=1.3.0    # 日志聚类（K-Means、DBSCAN）
```

## 优先级

**P0 (必须实现)**
- AC 1: 日志采集准确性
- AC 2: 日志解析准确性
- AC 5: 日志过滤性能
- 核心功能点 1, 7

**P1 (首版本必备)**
- AC 3: 模式识别
- AC 4: 异常检测
- AC 6: 日志关联分析
- 核心功能点 2, 3, 5

**P2 (后续版本优化)**
- AC 7: 日志搜索准确性
- AC 8: 多日志源支持
- 核心功能点 4, 6, 8

## 输出示例

### 日志模式识别输出
```bash
$ aiops logs --path /var/log/app.log --pattern-detect --period 1h

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 日志模式识别报告                                     2024-01-15 14:30:25 ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 日志文件: /var/log/app.log                                       │
│ 时间范围: 2024-01-15 13:30:00 - 14:30:00                        │
│ 总日志条数: 125,432                                              │
│ 识别模式数: 48                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 📊 Top 20 日志模式:                                               │
│   ┌──────┬────────────────────────────────┬──────────┬────────┐  │
│   │ 排名 │ 模板                           │   数量   │ 占比   │  │
│   ├──────┼────────────────────────────────┼──────────┼────────┤  │
│   │  1   │ INFO Request received          │  45,231  │ 36.1%  │  │
│   │  2   │ INFO Request completed         │  45,123  │ 36.0%  │  │
│   │  3   │ DEBUG SQL query executed       │  15,234  │ 12.1%  │  │
│   │  4   │ WARN Slow query (>1s)          │   8,234  │  6.6%  │  │
│   │  5   │ ERROR Connection timeout       │   3,456  │  2.8%  │  │
│   │  6   │ ERROR Database connection lost │   2,123  │  1.7%  │  │
│   │  7   │ INFO Health check passed       │   1,890  │  1.5%  │  │
│   │  8   │ ERROR Invalid API key          │   1,234  │  1.0%  │  │
│   │  9   │ WARN Rate limit exceeded       │     987  │  0.8%  │  │
│   │ 10   │ INFO Cache hit                 │     876  │  0.7%  │  │
│   │ ...  │ ...                            │     ...  │  ...   │  │
│   └──────┴────────────────────────────────┴──────────┴────────┘  │
│                                                                  │
│ ⚠️  异常模式检测 (出现频率 < 0.1%):                                │
│   1. CRITICAL Out of memory during file upload (3 次)            │
   2. ERROR SSL certificate verification failed (2 次)             │
│   3. FATAL Kernel panic (1 次)                                    │
│                                                                  │
│ 📈 日志级别分布:                                                  │
│   INFO:  92.3%                                                  │
│   DEBUG: 2.1%                                                   │
│   WARN:  4.2%                                                   │
│   ERROR: 1.3%                                                   │
│   FATAL: 0.1%                                                   │
│                                                                  │
│ 💡 建议:                                                          │
│   - ERROR 级别日志占比 1.3%，建议优化以下错误:                     │
│     • Connection timeout (2.8%) - 检查网络和后端服务              │
│     • Database connection lost (1.7%) - 检查数据库连接池          │
│   - 调查 CRITICAL 级别日志（内存不足）                              │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 日志关联分析输出
```bash
$ aiops logs --correlate --anomaly-time 2024-01-15T14:15:00 --window 10m

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 日志关联分析报告                                     2024-01-15 14:30:25 ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 异常时间: 2024-01-15 14:15:23                                   │
│ 时间窗口: 14:05:23 - 14:25:23 (前后 10 分钟)                      │
├──────────────────────────────────────────────────────────────────┤
│ 📊 系统指标 (异常时段):                                           │
│   - CPU: 94.2% (基线: 45.3%) ⬆️ 108%                            │
│   - 内存: 85.6% (基线: 52.1%) ⬆️ 64%                             │
│   - 磁盘 IO: 高等待 (await: 285ms)                              │
│   - 网络: 正常                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 📝 关键日志事件 (按时间排序):                                      │
│                                                                  │
│ ⏰ 前兆日志 (异常前 10 分钟):                                      │
│   14:05:45 [INFO] Application started                            │
│   14:08:12 [WARN] Memory usage > 70%                             │
│   14:10:23 [WARN] Memory usage > 80%                             │
│   14:12:45 [ERROR] Failed to allocate memory (size: 512MB)       │
│   14:13:01 [WARN] GC pause time > 5s (5.2s)                     │
│   14:14:12 [ERROR] Out of memory: Cannot allocate 256MB         │
│   14:14:56 [CRITICAL] Memory exhausted, starting OOM handler    │
│                                                                  │
│ 🚨 异常发生 (14:15:23):                                          │
│   14:15:23 [FATAL] Out of Memory: Killed process 15234 (java)   │
│             oom-killer: score 891                                │
│   14:15:25 [ERROR] Application crashed, restarting...           │
│                                                                  │
│ 🔥 后续日志 (异常后 10 分钟):                                      │
│   14:15:30 [INFO] Attempting to restart application              │
│   14:15:45 [WARN] Slow startup: 15s elapsed                     │
│   14:16:00 [INFO] Application restarted successfully             │
│   14:16:12 [WARN] High GC frequency (3 times in 1 minute)        │
│   14:18:23 [INFO] Memory usage stabilized at 65%                │
│   14:20:45 [INFO] Application recovered                          │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 🔍 根因分析:                                                      │
│   主要原因: 内存不足导致 OOM                                      │
│   证据链:                                                       │
│     1. 14:08 开始内存持续增长                                     │
│     2. 14:12 开始出现内存分配失败                                 │
│     3. 14:14 出现内存耗尽警告                                     │
│     4. 14:15 OOM killer 终止进程                                  │
│                                                                  │
│   可能原因:                                                      │
│     - 内存泄漏（Java 堆持续增长）                                 │
│     - 内存配置不足（堆大小 4GB 不足以支撑负载）                    │
│     - 突发流量（异常时间段请求量 +50%）                           │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 💡 建议操作:                                                      │
│   短期:                                                          │
│     1. 增加堆内存: -Xmx8g                                       │
│     2. 启用更详细的 GC 日志: -Xlog:gc*                          │
│     3. 监控内存告警阈值: 80%                                      │
│                                                                  │
│   长期:                                                          │
│     1. 排查内存泄漏: jmap -histo <pid>                          │
│     2. 优化应用内存使用                                          │
│     3. 配置 OOM 保护: oom_score_adj                              │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

## 后续演进方向

1. **日志实时流处理**: 支持 Kafka、Fluentd 集成
2. **日志自动标注**: 识别日志类型（Web、数据库、缓存等）
3. **日志语义理解**: 使用 NLP 理解日志含义
4. **跨主机日志关联**: 分布式追踪和关联
