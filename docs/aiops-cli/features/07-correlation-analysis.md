# 特性 07: 多维度关联分析与问题定界

## 功能概述

提供多维度关联分析能力，将系统各层面指标（CPU、内存、磁盘 IO、网络、进程、日志）进行时空关联，自动定位问题发生的层面（基础设施、操作系统、应用）和范围（单机、集群、特定服务），实现快速问题定界和根因定位。

## 用户场景

**场景 1: 系统性能下降，不知问题在哪**
- 系统整体变慢，但不清楚是哪个子系统出问题
- 需要快速定位问题层面（CPU/内存/IO/网络）
- 使用 `aiops correlate --all --time-range 30m` 全面关联分析

**场景 2: 应用响应慢，需要区分基础设施还是应用问题**
- 应用响应时间增加，怀疑是基础设施问题
- 需要判断是 OS 资源不足还是应用性能问题
- 使用 `aiops diagnose --app-slow --latency` 诊断慢响应根因

**场景 3: 异常事件关联**
- 系统出现异常，需要找出所有相关指标和日志
- 需要构建事件时间线
- 使用 `aiops timeline --event <timestamp>` 生成事件时间线

## 技术方案概要

### 数据关联层
- **时间对齐**: 将所有指标和日志按时间戳对齐
- **时间窗口**: 定义异常时间窗口（前后 N 分钟）
- **采样聚合**: 将高频率指标聚合为统一粒度（如 10 秒）
- **数据融合**: 合并多源数据（指标、日志、事件）

### 关联分析算法
- **皮尔逊相关系数**: 计算指标间的线性相关性
- **时序相关性**: 计算时序数据的滞后相关性（Granger causality）
- **因果推断**: 基于结构因果模型（SCM）推断因果关系
- **异常传播分析**: 识别异常如何在系统层级间传播
- **聚类分析**: 将相关指标聚类，识别异常指标组

### 问题定界策略
- **层次化分析**: 从硬件 -> OS -> 应用 -> 业务逐层分析
- **排除法**: 逐层排除正常层次，缩小问题范围
- **症状映射**: 将用户症状映射到系统指标
- **依赖分析**: 基于系统依赖关系图分析传播路径

## 核心功能点

### 1. 全局关联分析
```bash
# 全局关联分析所有指标
aiops correlate --all --time-range 1h
```
- 关联 CPU、内存、磁盘、网络、进程、日志
- 计算指标间的相关性
- 识别异常指标组
- 生成关联热力图

### 2. 问题定界
```bash
# 快速定位问题层面
aiops diagnose --symptom "应用响应慢" --time-range 30m
```
- 基于症状自动分析可能的根因层次
- 逐层排除正常层次
- 缩小问题范围到具体层次
- 提供下一步诊断建议

### 3. 事件时间线
```bash
# 生成事件时间线
aiops timeline --event 2024-01-15T14:15:00 --window 10m
```
- 提取异常时间窗口内的所有事件
- 按时间排序展示
- 标注关键事件（异常开始、症状出现、恢复）
- 关联指标变化和日志

### 4. 指标相关性分析
```bash
# 分析指标相关性
aiops correlate --metrics cpu,mem,disk --time-range 1d
```
- 计算指标间的相关系数
- 识别高度相关的指标对
- 分析滞后相关性（A 是否领先 B）
- 识别因果关系

### 5. 异常传播分析
```bash
# 分析异常如何在系统中传播
aiops trace-anomaly --start-time 2024-01-15T14:15:00
```
- 追踪异常的传播路径
- 识别异常的源头和影响范围
- 构建异常传播树
- 提供阻断建议

### 6. 对比分析
```bash
# 对比正常时段和异常时段
aiops compare --normal "2024-01-15 10:00-11:00" --anomaly "2024-01-15 14:00-15:00"
```
- 对比两个时间段的指标差异
- 识别显著变化的指标
- 对比进程列表和资源占用
- 对比日志模式

### 7. 根因假设生成
```bash
# 生成根因假设
aiops hypothesize --event 2024-01-15T14:15:00
```
- 基于关联分析生成可能的根因假设
- 计算每个假设的置信度
- 提供验证步骤
- 支持假设验证反馈

### 8. 依赖关系分析
```bash
# 分析系统依赖关系
aiops analyze-dependencies --pid <pid>
```
- 构建进程依赖图
- 识别关键路径和单点故障
- 分析服务间的依赖关系
- 评估故障影响范围

## 验收标准 (Acceptance Criteria)

### AC 1: 时间对齐准确性
- **Given**: 多个指标源（CPU 1s 采样，内存 5s 采样）
- **When**: 执行 `aiops correlate --all`
- **Then**:
  - 所有指标按时间戳正确对齐
  - 不同采样率的指标正确聚合
  - 时间戳误差 < 1s

### AC 2: 关联分析准确性
- **Given**: 指标间存在已知相关性
- **When**: 执行 `aiops correlate --metrics cpu,loadavg`
- **Then**:
  - 识别出高度相关性（相关系数 > 0.8）
  - 相关性计算正确（与手工计算对比）
  - 支持滞后相关性检测

### AC 3: 问题定界准确性
- **Given**: 系统存在已知的 CPU 瓶颈
- **When**: 执行 `aiops diagnose --symptom "系统慢" --time-range 30m`
- **Then**:
  - 正确定位到 CPU 层面（准确率 >= 85%）
  - 排除正常层面（内存、网络）
  - 提供的诊断路径合理

### AC 4: 事件时间线完整性
- **Given**: 异常时间窗口内有多个事件
- **When**: 执行 `aiops timeline --event <timestamp> --window 10m`
- **Then**:
  - 提取所有相关事件（指标异常、日志、进程变化）
  - 时间顺序正确
  - 关键事件标注准确

### AC 5: 性能与资源占用
- **Given**: 系统运行正常
- **When**: 执行 `aiops correlate --all --time-range 1d`
- **Then**:
  - 分析时间 < 30 秒（1 天数据）
  - 内存占用 < 1GB
  - CPU 占用 < 50%（短时间）

### AC 6: 对比分析准确性
- **Given**: 正常时段和异常时段数据
- **When**: 执行 `aiops compare --normal <time1> --anomaly <time2>`
- **Then**:
  - 识别显著差异的指标（P值 < 0.05）
  - 差异幅度计算正确
  - 提供的差异解释合理

### AC 7: 根因假设质量
- **Given**: 已知的故障场景
- **When**: 执行 `aiops hypothesize --event <timestamp>`
- **Then**:
  - 生成的假设包含真实根因（Top 3 假设中）
  - 假设的置信度计算合理
  - 提供的验证步骤可操作

### AC 8: 依赖关系图准确性
- **Given**: 系统有多个进程和服务
- **When**: 执行 `aiops analyze-dependencies --pid <pid>`
- **Then**:
  - 正确识别进程的父子关系
  - 正确识别网络连接依赖
  - 正确识别文件依赖
  - 依赖关系图可视化清晰

## 依赖项

### 系统依赖
- **操作系统**: Linux (内核 >= 3.10)
- **Python**: Python 3.8+

### Python 库依赖
```
pandas>=2.0.0          # 数据处理和对齐
numpy>=1.24.0          # 数值计算
scipy>=1.10.0          # 统计分析（相关系数）
scikit-learn>=1.3.0    # 聚类和异常检测
networkx>=3.1          # 图分析（依赖关系）
click>=8.1.0           # CLI 框架
rich>=13.0.0           # 终端美化
```

### 可选依赖
```
matplotlib>=3.7.0      # 相关性热力图
plotly>=5.14.0         # 交互式图表
```

## 优先级

**P0 (必须实现)**
- AC 1: 时间对齐准确性
- AC 5: 性能与资源占用
- 核心功能点 1, 3

**P1 (首版本必备)**
- AC 2: 关联分析
- AC 3: 问题定界
- AC 4: 事件时间线
- 核心功能点 2, 4, 6

**P2 (后续版本优化)**
- AC 6: 对比分析
- AC 7: 根因假设
- AC 8: 依赖关系
- 核心功能点 5, 7, 8

## 输出示例

### 全局关联分析输出
```bash
$ aiops correlate --all --time-range 1h

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 多维度关联分析报告                                   2024-01-15 14:30:25 ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 分析时间范围: 2024-01-15 13:30:00 - 14:30:00                    │
│ 指标源: CPU、内存、磁盘 IO、网络、进程、日志                     │
├──────────────────────────────────────────────────────────────────┤
│ 🔍 异常事件摘要:                                                  │
│   检测到 2 个异常时段:                                          │
│   1. 13:45:10 - 13:47:30 (2 分 20 秒) - Warning                 │
│   2. 14:15:23 - 14:20:45 (5 分 22 秒) - Critical ⚠️              │
├──────────────────────────────────────────────────────────────────┤
│ 📊 关键事件时间线 (Critical 事件):                                 │
│                                                                  │
│   14:10:00 [正常] CPU: 45%, 内存: 52%, IO: 正常                 │
│   14:12:45 [警告] 内存使用 > 80%                                 │
│   14:13:01 [异常] GC pause > 5s                                  │
│   14:14:12 [错误] 内存分配失败                                   │
│   14:15:00 [异常] CPU 开始上升: 45% -> 60%                      │
│   14:15:23 [异常] Java 进程 OOM killed                          │
│   14:15:25 [恢复] 系统自动重启进程                               │
│   14:16:00 [恢复] 内存使用稳定: 65%                              │
│   14:20:00 [恢复] 所有指标恢复正常                               │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 🎯 问题定界:                                                      │
│   问题层次: 操作系统层 -> 应用层                                  │
│   根因层次: 应用层（Java 进程内存泄漏）                           │
│   症状: 系统响应慢、OOM kill                                     │
│   影响范围: Java 应用服务                                         │
│                                                                  │
│   定界路径:                                                      │
│   ✅ 硬件层: 正常（无硬件故障）                                  │
│   ✅ 内核层: 正常（无内核错误）                                  │
│   ⚠️  资源层: 异常（内存不足）                                   │
│   ⚠️  进程层: 异常（Java 进程内存泄漏）                          │
│   ❓ 应用层: 需进一步分析（可能是内存泄漏或配置不当）             │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 📈 指标相关性分析:                                                │
│   高度相关 (|r| > 0.8):                                         │
│     • CPU 使用率 ↔ 负载均衡 (r = 0.95)                           │
│     • 内存使用率 ↔ Swap 使用率 (r = 0.88)                        │
│     • Java 进程内存 ↔ 系统内存 (r = 0.92)                       │
│                                                                  │
│   滞后相关 (A 领先 B):                                          │
│     • Java 进程内存 → 系统内存 (领先 2 分钟)                     │
│     • GC 频率 → CPU 使用率 (领先 30 秒)                         │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 🎯 根因假设 (按置信度排序):                                       │
│   1. Java 进程内存泄漏 (置信度: 92%)                              │
│      证据: 内存持续增长、GC 频率增加、最终 OOM                   │
│      验证: jmap -histo <pid> 分析堆内存                         │
│                                                                  │
│   2. Java 堆内存配置不足 (置信度: 65%)                           │
│      证据: 峰值内存接近堆上限                                   │
│      验证: 检查 -Xmx 配置                                        │
│                                                                  │
│   3. 突发流量导致内存峰值 (置信度: 30%)                           │
│      证据: 异常时间段请求量 +50%（需验证）                       │
│      验证: 检查应用访问日志                                      │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 💡 下一步建议:                                                    │
│   1. 详细分析 Java 进程:                                         │
│      aiops analyze memory --pid 15234 --trend                   │
│   2. 检查应用日志:                                               │
│      aiops logs --path /var/log/app.log --correlate             │
│   3. 生成堆转储:                                                 │
│      jmap -dump:live,format=b,file=heap.hprof 15234            │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 问题定界输出
```bash
$ aiops diagnose --symptom "应用响应慢" --time-range 30m

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ 问题定界诊断                                         2024-01-15 14:30:25 ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 症状: 应用响应慢                                                │
│ 时间范围: 2024-01-15 14:00:00 - 14:30:00                        │
├──────────────────────────────────────────────────────────────────┤
│ 🔍 逐层分析:                                                      │
│                                                                  │
│ 第 1 层: 硬件层                                                   │
│   ✅ CPU: 正常（频率 2.4GHz，无降频）                            │
│   ✅ 内存: 正常（无 ECC 错误）                                   │
│   ✅ 磁盘: 正常（SMART 状态良好）                                │
│   ✅ 网络: 正常（链路 up，无错误包）                             │
│   结论: 硬件层正常，不是硬件问题                                  │
│                                                                  │
│ 第 2 层: 操作系统内核层                                           │
│   ✅ 内核版本: 5.4.0（稳定）                                     │
│   ✅ 内核日志: 无错误或警告                                      │
│   ✅ 内核参数: 正常（无异常调优）                                 │
│   ✅ 中断: 正常（无中断风暴）                                    │
│   结论: 内核层正常，不是内核问题                                  │
│                                                                  │
│ 第 3 层: 系统资源层                                               │
│   ⚠️  CPU: 异常（使用率 94%，基线 45%）                          │
│   ⚠️  内存: 异常（使用率 85%，基线 52%）                          │
│   ⚠️  磁盘 IO: 异常（await 285ms，基线 12ms）                    │
│   ✅ 网络: 正常（带宽使用 < 20%）                                │
│   结论: 资源层异常，存在资源瓶颈                                  │
│                                                                  │
│ 第 4 层: 进程层                                                   │
│   ⚠️  Top 进程:                                                 │
│     • java (PID 15234): CPU 67%, 内存 3.8GB                     │
│     • mysqld (PID 2891): CPU 12%, 内存 1.2GB                    │
│   ⚠️  进程状态: Java 进程频繁 GC，CPU 等待 IO                    │
│   结论: 进程层异常，Java 进程是主要瓶颈                          │
│                                                                  │
│ 第 5 层: 应用层                                                   │
│   ❓ 需进一步分析                                                │
│   可能原因:                                                      │
│     • 应用代码问题（内存泄漏、死锁）                              │
│     • 配置问题（堆内存不足、连接池配置）                          │
│     • 外部依赖问题（数据库慢、第三方服务）                        │
│   结论: 应用层需要深入分析                                       │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 🎯 定界结论:                                                      │
│   问题层次: 系统资源层 → 进程层 → 应用层                          │
│   根因定位: 应用层（Java 进程）                                  │
│   症状原因: Java 进程内存泄漏 → OOM → 系统重启 → 响应慢          │
│   影响范围: Java 应用服务及依赖服务                              │
│                                                                  │
│ 问题类型: 应用性能问题（非基础设施问题）                          │
│ 优先级: P1 (高)                                                 │
│ 建议处理人: 应用开发团队                                         │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│ 💡 下一步诊断:                                                    │
│   应用层分析:                                                    │
│     1. 分析应用日志:                                             │
│        aiops logs --path /var/log/app.log --level error         │
│     2. 分析内存趋势:                                             │
│        aiops analyze memory --pid 15234 --trend                 │
│     3. 分析数据库性能:                                           │
│        aiops analyze database --slow-queries                    │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

## 后续演进方向

1. **分布式追踪**: 集成 OpenTelemetry，支持分布式追踪
2. **拓扑图可视化**: 自动生成系统拓扑和依赖关系图
3. **自动定界**: 基于规则的自动定界引擎
4. **根因推荐**: 基于历史案例的根因推荐系统
